{% extends "core/base.html" %}

{% block title %}Charts • theTowerStats{% endblock %}

{% block content %}
    <h2>Import Battle Report</h2>
    <form method="post">
      {% csrf_token %}
      {{ import_form.as_p }}
      <button type="submit">Import</button>
    </form>

    <h2>
      {{ metric_definition.label }}
      <span class="muted">({{ metric_definition.kind }})</span>
    </h2>
    <div class="context-bar" aria-live="polite">
      <div class="context-bar__title">Active context</div>
      <div id="active-context" class="muted"></div>
    </div>
    <form method="get" id="chart-context-form">
      {{ chart_form.as_p }}
      <button type="submit">Apply</button>
      <a href="{% url 'core:dashboard' %}">Clear</a>
    </form>

    {% if metric_definition.kind == "derived" %}
      <div class="empty-state" role="note">
        <strong>Derived metric transparency</strong>
        {% if metric_assumptions %}
          <ul>
            {% for assumption in metric_assumptions %}
              <li>{{ assumption }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if used_parameters %}
          <details>
            <summary>Parameters referenced</summary>
            <ul>
              {% for param in used_parameters %}
                <li>
                  {{ param.entity_type }} • {{ param.entity_name }} • {{ param.key }} = {{ param.raw_value }}
                  {% if param.wiki_revision_id %}(wiki rev {{ param.wiki_revision_id }}){% endif %}
                </li>
              {% endfor %}
            </ul>
          </details>
        {% endif %}
      </div>
    {% endif %}

    <h3>Compare</h3>
    <form method="get">
      {{ comparison_form.as_p }}
      <button type="submit">Compare</button>
    </form>

    {% if comparison_result %}
      <div>
        <h4>Deltas ({{ comparison_result.metric }})</h4>
        {% if comparison_result.kind == "runs" %}
          <p>
            Baseline: Run A ({{ comparison_result.label_a }}) • Comparison: Run B ({{ comparison_result.label_b }})
          </p>
        {% else %}
          <p>
            Baseline: Window A ({{ comparison_result.window_a.start_date }} to {{ comparison_result.window_a.end_date }})
            • Comparison: Window B ({{ comparison_result.window_b.start_date }} to {{ comparison_result.window_b.end_date }})
          </p>
        {% endif %}
        <ul>
          <li>
            Baseline: {{ comparison_result.baseline_value|floatformat:2 }} {{ comparison_result.metric }}
          </li>
          <li>
            Comparison: {{ comparison_result.comparison_value|floatformat:2 }} {{ comparison_result.metric }}
          </li>
          <li>Absolute: {{ comparison_result.delta.absolute|floatformat:2 }}</li>
          {% if comparison_result.percent_display is not None %}
            <li>Percent: {{ comparison_result.percent_display|floatformat:2 }}%</li>
          {% else %}
            <li>Percent: n/a (baseline is 0)</li>
          {% endif %}
        </ul>
      </div>
    {% endif %}

    {% if chart_empty_state %}
      <div class="empty-state" role="status">{{ chart_empty_state }}</div>
    {% endif %}

    <canvas id="chart" width="900" height="350" {% if chart_empty_state %}hidden{% endif %}></canvas>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const labels = {{ chart_labels_json|safe }};
      const datasets = {{ chart_datasets_json|safe }};
      const initialContext = {{ chart_context_json|safe }};

      function formatCompactNumber(value) {
        const absValue = Math.abs(Number(value));
        if (!Number.isFinite(absValue)) return String(value);
        if (absValue >= 1_000_000_000) return (value / 1_000_000_000).toFixed(2) + "B";
        if (absValue >= 1_000_000) return (value / 1_000_000).toFixed(2) + "M";
        if (absValue >= 1_000) return (value / 1_000).toFixed(2) + "K";
        return String(value);
      }

      function formatExactNumber(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return String(value);
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(num);
      }

      function readChartContextFromDOM() {
        const form = document.getElementById("chart-context-form");
        if (!form) return initialContext;

        const getValue = (name) => {
          const el = form.elements[name];
          if (!el) return null;
          if (el.value === "") return null;
          return el.value;
        };

        const presetEl = form.elements["preset"];
        const presetLabel =
          presetEl && presetEl.selectedIndex >= 0 ? presetEl.options[presetEl.selectedIndex].text : null;

        const metricEl = form.elements["metric"];
        const metricLabel =
          metricEl && metricEl.selectedIndex >= 0 ? metricEl.options[metricEl.selectedIndex].text : null;

        return {
          metric: metricLabel || getValue("metric"),
          start_date: getValue("start_date"),
          end_date: getValue("end_date"),
          tier: getValue("tier"),
          preset: presetLabel && presetLabel !== "All presets" ? presetLabel : null,
          overlay_group: getValue("overlay_group") || "none",
          moving_average_window: getValue("moving_average_window"),
        };
      }

      function contextLabel(context) {
        const start = context.start_date || "Any start";
        const end = context.end_date || "Any end";
        const metric = context.metric ? `Metric: ${context.metric}` : "Metric: (default)";
        const tier = context.tier ? `Tier ${context.tier}` : "All tiers";
        const preset = context.preset ? `Preset: ${context.preset}` : "All presets";
        const overlay =
          context.overlay_group && context.overlay_group !== "none"
            ? `Overlay: ${context.overlay_group}`
            : "Overlay: none";
        const ma = context.moving_average_window ? `Moving average: ${context.moving_average_window}` : "Moving average: off";
        return `${metric} • ${tier} • ${preset} • ${start} → ${end} • ${overlay} • ${ma}`;
      }

      function updateContextSummary() {
        const el = document.getElementById("active-context");
        if (!el) return;
        el.textContent = contextLabel(readChartContextFromDOM());
      }

      updateContextSummary();
      const chartContextForm = document.getElementById("chart-context-form");
      if (chartContextForm) {
        chartContextForm.addEventListener("input", updateContextSummary);
        chartContextForm.addEventListener("change", updateContextSummary);
      }

      const canvas = document.getElementById("chart");
      const ctx = canvas ? canvas.getContext("2d") : null;
      if (!ctx || labels.length === 0 || datasets.length === 0) {
        // Empty state is rendered server-side.
      } else {
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            interaction: { mode: "nearest", intersect: false },
            plugins: {
              legend: {
                display: true,
                labels: { usePointStyle: true },
                onClick: (_event, legendItem, legend) => {
                  const datasetIndex = legendItem?.datasetIndex;
                  if (typeof datasetIndex !== "number") return;
                  const chart = legend?.chart;
                  if (!chart) return;
                  chart.setDatasetVisibility(datasetIndex, !chart.isDatasetVisible(datasetIndex));
                  chart.update();
                },
              },
              tooltip: {
                callbacks: {
                  title: (items) => (items && items[0] ? `Date: ${items[0].label}` : ""),
                  label: (context) => {
                    const datasetLabel = context.dataset?.label || "Series";
                    const unit = context.dataset?.unit || "";
                    const unitLabel = unit ? ` ${unit}` : "";
                    return `${datasetLabel}: ${formatExactNumber(context.parsed.y)}${unitLabel}`;
                  },
                  afterBody: () => {
                    const context = readChartContextFromDOM();
                    const lines = [];
                    if (context.tier) lines.push(`Filter tier: ${context.tier}`);
                    if (context.preset) lines.push(`Filter preset: ${context.preset}`);
                    if (context.start_date || context.end_date) {
                      lines.push(`Date range: ${context.start_date || "…"} → ${context.end_date || "…"}`);
                    }
                    if (context.overlay_group && context.overlay_group !== "none") {
                      lines.push(`Overlay: ${context.overlay_group}`);
                    }
                    if (context.moving_average_window) {
                      lines.push(`Moving average window: ${context.moving_average_window}`);
                    }
                    return lines;
                  },
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: "Date" },
                ticks: { maxRotation: 0, autoSkip: true },
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: datasets[0]?.unit || "Value" },
                ticks: {
                  callback: (value) => formatCompactNumber(value),
                },
              },
            },
          },
        });
      }
    </script>
{% endblock %}
