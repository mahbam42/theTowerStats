{% extends "core/base.html" %}

{% block title %}Charts • theTowerStats{% endblock %}

{% block head %}
{% endblock %}

{% block content %}
  <div class="grid-x grid-margin-x">
    <div class="cell">
      <div class="card-shell">
        <div class="grid-x grid-margin-x align-middle">
          <div class="cell auto">
            <p class="muted margin-0">Charts</p>
            <h2 class="margin-0">Dashboard</h2>
            <p class="muted margin-0">Filters default to December 9, 2025 to focus on recent runs.</p>
          </div>
          <div class="cell shrink text-right">
            <a class="button secondary" href="{% url 'core:battle_history' %}">Battle History</a>
            <p class="muted text-right margin-0">Battle History includes Battle Report import and run browsing.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="charts-layout">
    <div class="card-shell charts-context">
      <h4 class="margin-bottom-1">Context</h4>
      <form method="get" id="chart-context-form">
        <input type="hidden" name="builder" id="builder-flag" value="{% if chart_builder_form.is_bound %}1{% endif %}">
        <input type="hidden" name="chart_type" id="builder-chart-type-hidden" value="{{ chart_builder_form.chart_type.value|default_if_none:'' }}">
        <input type="hidden" name="group_by" id="builder-group-by-hidden" value="{{ chart_builder_form.group_by.value|default_if_none:'' }}">
        <input type="hidden" name="comparison" id="builder-comparison-hidden" value="{{ chart_builder_form.comparison.value|default_if_none:'' }}">
        <input type="hidden" name="smoothing" id="builder-smoothing-hidden" value="{{ chart_builder_form.smoothing.value|default_if_none:'' }}">
        <input type="hidden" name="run_a" id="builder-run-a-hidden" value="{{ chart_builder_form.run_a.value|default_if_none:'' }}">
        <input type="hidden" name="run_b" id="builder-run-b-hidden" value="{{ chart_builder_form.run_b.value|default_if_none:'' }}">
        <input type="hidden" name="window_a_start" id="builder-window-a-start-hidden" value="{{ chart_builder_form.window_a_start.value|default_if_none:'' }}">
        <input type="hidden" name="window_a_end" id="builder-window-a-end-hidden" value="{{ chart_builder_form.window_a_end.value|default_if_none:'' }}">
        <input type="hidden" name="window_b_start" id="builder-window-b-start-hidden" value="{{ chart_builder_form.window_b_start.value|default_if_none:'' }}">
        <input type="hidden" name="window_b_end" id="builder-window-b-end-hidden" value="{{ chart_builder_form.window_b_end.value|default_if_none:'' }}">
        <div id="builder-metric-keys-hidden">
          {% if chart_builder_form.is_bound %}
            {% for key in chart_builder_form.metric_keys.value %}
              <input type="hidden" name="metric_keys" value="{{ key }}">
            {% endfor %}
          {% endif %}
        </div>

        <div class="grid-x grid-margin-x align-middle">
          <div class="cell medium-2">
            <label class="margin-bottom-0">Start
              {{ chart_form.start_date }}
            </label>
          </div>
          <div class="cell medium-2">
            <label class="margin-bottom-0">End
              {{ chart_form.end_date }}
            </label>
          </div>
          <div class="cell medium-2">
            <label class="margin-bottom-0">Tier
              {{ chart_form.tier }}
            </label>
          </div>
          <div class="cell medium-3">
            <label class="margin-bottom-0">Preset
              {{ chart_form.preset }}
            </label>
          </div>
          <div class="cell shrink">
            <button class="button secondary" type="button" id="open-chart-builder">Chart Builder</button>
          </div>
          <div class="cell shrink">
            <button class="button" type="submit">Apply</button>
          </div>
          <div class="cell shrink">
            <a class="button secondary" href="{% url 'core:dashboard' %}">Clear</a>
          </div>
        </div>

        <details class="margin-top-1">
          <summary class="muted">More options</summary>
          <div class="grid-x grid-margin-x margin-top-1">
            <div class="cell medium-4">
              <label>Charts
                {{ chart_form.charts }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Rolling window
                {{ chart_form.window_kind }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Rolling window size
                {{ chart_form.window_n }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Ultimate Weapon
                {{ chart_form.ultimate_weapon }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Guardian Chip
                {{ chart_form.guardian_chip }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Bot
                {{ chart_form.bot }}
              </label>
            </div>
            <div class="cell medium-4">
              <label>Moving average window
                {{ chart_form.moving_average_window }}
              </label>
            </div>
          </div>

          <details class="margin-top-1">
            <summary class="muted">Advanced analysis</summary>
            <div class="margin-top-1">
              <h5 class="margin-bottom-0">Advice</h5>
              <p class="muted">Advice is descriptive and based on the selected snapshots and current filters.</p>
              <label>Snapshot A
                <select name="advice_snapshot_a" id="advice-snapshot-a">
                  <option value="">(select)</option>
                  {% for snapshot in chart_snapshots %}
                    <option value="{{ snapshot.id }}"{% if advice_snapshot_a|default:"" == snapshot.id|stringformat:"s" %} selected{% endif %}>{{ snapshot.name }}</option>
                  {% endfor %}
                </select>
              </label>
              <label>Compare
                <select name="advice_mode" id="advice-mode">
                  <option value="snapshot_vs_current"{% if advice_mode == "snapshot_vs_current" %} selected{% endif %}>Snapshot vs current filters</option>
                  <option value="snapshot_vs_snapshot"{% if advice_mode == "snapshot_vs_snapshot" %} selected{% endif %}>Snapshot vs snapshot</option>
                </select>
              </label>
              <label>Snapshot B
                <select name="advice_snapshot_b" id="advice-snapshot-b">
                  <option value="">(select)</option>
                  {% for snapshot in chart_snapshots %}
                    <option value="{{ snapshot.id }}"{% if advice_snapshot_b|default:"" == snapshot.id|stringformat:"s" %} selected{% endif %}>{{ snapshot.name }}</option>
                  {% endfor %}
                </select>
              </label>

              <h6 class="margin-bottom-0">Goal-aware comparison</h6>
              <p class="muted">Goal-aware advice summarizes percent changes across multiple metrics using the weights you select.</p>
              <label>Goal
                <select name="goal_intent" id="goal-intent">
                  <option value="hybrid"{% if goal_intent == "hybrid" %} selected{% endif %}>Hybrid</option>
                  <option value="economy"{% if goal_intent == "economy" %} selected{% endif %}>Economy / Farming</option>
                  <option value="progression"{% if goal_intent == "progression" %} selected{% endif %}>Progression / Wave Push</option>
                </select>
              </label>
              <div class="grid-x grid-margin-x">
                <div class="cell medium-4">
                  <label>Weight: coins/hour
                    <input type="number" step="0.05" name="goal_weight_coins_per_hour" id="goal-weight-coins-per-hour" value="{{ goal_weight_coins_per_hour|default_if_none:'' }}">
                  </label>
                </div>
                <div class="cell medium-4">
                  <label>Weight: coins/wave
                    <input type="number" step="0.05" name="goal_weight_coins_per_wave" id="goal-weight-coins-per-wave" value="{{ goal_weight_coins_per_wave|default_if_none:'' }}">
                  </label>
                </div>
                <div class="cell medium-4">
                  <label>Weight: waves reached
                    <input type="number" step="0.05" name="goal_weight_waves_reached" id="goal-weight-waves-reached" value="{{ goal_weight_waves_reached|default_if_none:'' }}">
                  </label>
                </div>
              </div>

              <div class="button-group expanded stack-for-small margin-top-1">
                <a class="button secondary" href="{% url 'core:export_derived_metrics_csv' %}?{{ request.GET.urlencode }}">Export derived metrics (CSV)</a>
              </div>
            </div>
          </details>
        </details>
      </form>
    </div>

    <div class="charts-content">
      <div class="callout primary context-bar" aria-live="polite">
        <strong>Active context</strong>
        <div id="active-context" class="muted"></div>
      </div>

      {% if comparison_result %}
        <div class="callout success">
          <p class="margin-0"><strong>Deltas ({{ comparison_result.metric }})</strong></p>
          {% if comparison_result.kind == "runs" %}
            <p class="margin-0">
              Baseline: Run A ({{ comparison_result.label_a }}) • Comparison: Run B ({{ comparison_result.label_b }})
            </p>
          {% else %}
            <p class="margin-0">
              Baseline: Window A ({{ comparison_result.window_a.start_date }} to {{ comparison_result.window_a.end_date }})
              • Comparison: Window B ({{ comparison_result.window_b.start_date }} to {{ comparison_result.window_b.end_date }})
            </p>
          {% endif %}
          <ul class="margin-bottom-0">
            <li>Baseline: {{ comparison_result.baseline_value|floatformat:2 }} {{ comparison_result.metric }}</li>
            <li>Comparison: {{ comparison_result.comparison_value|floatformat:2 }} {{ comparison_result.metric }}</li>
            <li>Absolute: {{ comparison_result.delta.absolute|floatformat:2 }}</li>
            {% if comparison_result.percent_display is not None %}
              <li>Percent: {{ comparison_result.percent_display|floatformat:2 }}%</li>
            {% else %}
              <li>Percent: n/a (baseline is 0)</li>
            {% endif %}
          </ul>
        </div>
      {% endif %}

      {% if advice_items %}
        <div class="callout">
          <p class="margin-0"><strong>Advice (read-only)</strong></p>
          <ul class="margin-bottom-0">
            {% for item in advice_items %}
              <li>{{ item.title }}</li>
              <li>{{ item.basis }}</li>
              <li>{{ item.context }}</li>
              <li>{{ item.limitations }}</li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}

      {% if chart_empty_state %}
        <div class="empty-state" role="status">{{ chart_empty_state }}</div>
      {% endif %}

      <div class="grid-x grid-margin-x" {% if chart_empty_state %}hidden{% endif %}>
        {% for panel in chart_panels %}
          <div class="cell">
            <div class="chart-shell margin-bottom-1">
              <div class="grid-x align-justify align-middle">
                <div class="cell auto">
                  <h4 class="margin-0">{{ panel.title }}{% if panel.unit %} <span class="muted">({{ panel.unit }})</span>{% endif %}</h4>
                  {% if panel.description %}
                    <p class="muted margin-0">{{ panel.description }}</p>
                  {% endif %}
                  {% if panel.error %}
                    <div class="callout alert margin-top-1">
                      <p class="margin-0"><strong>Chart unavailable</strong> — {{ panel.error }}</p>
                    </div>
                  {% endif %}
                  {% if panel.warnings %}
                    <div class="callout warning margin-top-1">
                      <p class="margin-0"><strong>Notes</strong></p>
                      <ul class="margin-bottom-0">
                        {% for warning in panel.warnings %}
                          <li>{{ warning }}</li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                </div>
                <div class="cell shrink">
                  <button type="button" class="button tiny secondary download-chart-png" data-chart-id="{{ panel.id }}">Download PNG</button>
                </div>
              </div>
              <canvas id="chart-{{ panel.id }}" width="900" height="350"></canvas>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="charts-controls">
      <div class="card-shell">
        <details>
          <summary class="muted">Compare</summary>
          <form method="get" class="margin-top-1">
            {{ comparison_form.as_p }}
            <button class="button secondary" type="submit">Compare</button>
          </form>
        </details>
      </div>

      {% if not demo_mode %}
        <div class="card-shell">
          <details>
            <summary class="muted">Quick import</summary>
            <div class="margin-top-1">
              <form method="post">
                {% csrf_token %}
                <label>{{ import_form.raw_text.label }}
                  {{ import_form.raw_text }}
                </label>
                <label>{{ import_form.preset_name.label }}
                  {{ import_form.preset_name }}
                </label>
                <button class="button expanded" type="submit">Import Battle Report</button>
              </form>
            </div>
          </details>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const chartPanels = {{ chart_panels_json|safe }};
      const initialContext = {{ chart_context_json|safe }};
      const chartBuilderMetricMeta = {{ chart_builder_metric_meta_json|safe }};

      function formatCompactNumber(value) {
        const absValue = Math.abs(Number(value));
        if (!Number.isFinite(absValue)) return String(value);
        if (absValue >= 1_000_000_000) return (value / 1_000_000_000).toFixed(2) + "B";
        if (absValue >= 1_000_000) return (value / 1_000_000).toFixed(2) + "M";
        if (absValue >= 1_000) return (value / 1_000).toFixed(2) + "K";
        return String(value);
      }

      function formatExactNumber(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return String(value);
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(num);
      }

      function readChartContextFromDOM() {
        const form = document.getElementById("chart-context-form");
        if (!form) return initialContext;

        const getValue = (name) => {
          const el = form.elements[name];
          if (!el) return null;
          if (el.value === "") return null;
          return el.value;
        };

        const presetEl = form.elements["preset"];
        const presetLabel =
          presetEl && presetEl.selectedIndex >= 0 ? presetEl.options[presetEl.selectedIndex].text : null;

        const chartsEl = form.elements["charts"];
        const selectedCharts = [];
        if (chartsEl && chartsEl.options) {
          for (const option of chartsEl.options) {
            if (option.selected) selectedCharts.push(option.text);
          }
        }

        return {
          charts: selectedCharts.length ? selectedCharts.join(", ") : null,
          start_date: getValue("start_date"),
          end_date: getValue("end_date"),
          tier: getValue("tier"),
          preset: presetLabel && presetLabel !== "All presets" ? presetLabel : null,
          moving_average_window: getValue("moving_average_window"),
          window_kind: getValue("window_kind"),
          window_n: getValue("window_n"),
        };
      }

      function contextLabel(context) {
        const start = context.start_date || "Any start";
        const end = context.end_date || "Any end";
        const charts = context.charts ? `Charts: ${context.charts}` : "Charts: (default)";
        const tier = context.tier ? `Tier ${context.tier}` : "All tiers";
        const preset = context.preset ? `Preset: ${context.preset}` : "All presets";
        const ma = context.moving_average_window ? `MA window: ${context.moving_average_window}` : "MA window: default";
        const window = context.window_kind
          ? `${context.window_kind.replace("_", " ")}: ${context.window_n || "?"}`
          : "Rolling window: none";
        return `${charts} • ${tier} • ${preset} • ${start} → ${end} • ${ma} • ${window}`;
      }

      function updateContextSummary() {
        const el = document.getElementById("active-context");
        if (!el) return;
        el.textContent = contextLabel(readChartContextFromDOM());
      }

      updateContextSummary();
      const chartContextForm = document.getElementById("chart-context-form");
      if (chartContextForm) {
        chartContextForm.addEventListener("input", updateContextSummary);
        chartContextForm.addEventListener("change", updateContextSummary);
      }

      function renderLineChart(canvasId, labels, datasets) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas ? canvas.getContext("2d") : null;
        if (!ctx || labels.length === 0 || datasets.length === 0) return;
        const gridColor = "rgba(0, 0, 0, 0.06)";
        const tickColor = "rgba(0, 0, 0, 0.72)";
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            interaction: { mode: "nearest", intersect: false },
            elements: {
              line: { borderWidth: 2 },
              point: { radius: 2, hoverRadius: 4 },
            },
            plugins: {
              legend: {
                display: true,
                labels: { usePointStyle: true },
                onClick: (_event, legendItem, legend) => {
                  const datasetIndex = legendItem?.datasetIndex;
                  if (typeof datasetIndex !== "number") return;
                  const chart = legend?.chart;
                  if (!chart) return;
                  chart.setDatasetVisibility(datasetIndex, !chart.isDatasetVisible(datasetIndex));
                  chart.update();
                },
              },
              tooltip: {
                callbacks: {
                  title: (items) => (items && items[0] ? `Date: ${items[0].label}` : ""),
                  label: (context) => {
                    const datasetLabel = context.dataset?.label || "Series";
                    const unit = context.dataset?.unit || "";
                    const unitLabel = unit ? ` ${unit}` : "";
                    const base = `${datasetLabel}: ${formatExactNumber(context.parsed.y)}${unitLabel}`;
                    const reasons = context.dataset?.flagReasons || null;
                    const reason =
                      reasons && Number.isInteger(context.dataIndex) ? reasons[context.dataIndex] : null;
                    return reason ? `${base} • ${reason}` : base;
                  },
                  afterBody: () => {
                    const context = readChartContextFromDOM();
                    const lines = [];
                    if (context.tier) lines.push(`Filter tier: ${context.tier}`);
                    if (context.preset) lines.push(`Filter preset: ${context.preset}`);
                    if (context.start_date || context.end_date) {
                      lines.push(`Date range: ${context.start_date || "…"} → ${context.end_date || "…"}`);
                    }
                    if (context.moving_average_window) {
                      lines.push(`Moving average window: ${context.moving_average_window}`);
                    }
                    if (context.window_kind) {
                      lines.push(`Rolling window: ${context.window_kind} (${context.window_n || "?"})`);
                    }
                    return lines;
                  },
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: "Date" },
                grid: { color: gridColor },
                ticks: { maxRotation: 0, autoSkip: true, color: tickColor },
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: datasets[0]?.unit || "Value" },
                grid: { color: gridColor },
                ticks: {
                  callback: (value) => formatCompactNumber(value),
                  color: tickColor,
                },
              },
            },
          },
        });
      }

      function renderBarChart(canvasId, labels, datasets) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas ? canvas.getContext("2d") : null;
        if (!ctx || labels.length === 0 || datasets.length === 0) return;
        const gridColor = "rgba(0, 0, 0, 0.06)";
        const tickColor = "rgba(0, 0, 0, 0.72)";
        new Chart(ctx, {
          type: "bar",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            datasets: { bar: { borderWidth: 1 } },
            plugins: {
              legend: { display: true },
              tooltip: {
                callbacks: {
                  title: (items) => (items && items[0] ? `Date: ${items[0].label}` : ""),
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: "Date" },
                grid: { color: gridColor },
                ticks: { maxRotation: 0, autoSkip: true, color: tickColor },
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: datasets[0]?.unit || "Value" },
                grid: { color: gridColor },
                ticks: { callback: (value) => formatCompactNumber(value), color: tickColor },
              },
            },
          },
        });
      }

      function renderDonutChart(canvasId, labels, datasets) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas ? canvas.getContext("2d") : null;
        if (!ctx || labels.length === 0 || datasets.length === 0) return;

        const unit = datasets[0]?.unit || "";
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: true, position: "right" },
              tooltip: {
                callbacks: {
                  title: (items) => (items && items[0] ? items[0].label : ""),
                  label: (context) => {
                    const value = context.parsed;
                    const unitLabel = unit ? ` ${unit}` : "";
                    return `${formatExactNumber(value)}${unitLabel}`;
                  },
                },
              },
            },
          },
        });
      }

      // Empty state is rendered server-side.
      for (const panel of chartPanels) {
        if (panel.chart_type === "donut") {
          renderDonutChart(`chart-${panel.id}`, panel.labels, panel.datasets);
        } else if (panel.chart_type === "bar") {
          renderBarChart(`chart-${panel.id}`, panel.labels, panel.datasets);
        } else {
          renderLineChart(`chart-${panel.id}`, panel.labels, panel.datasets);
        }
      }

      function downloadChartPng(chartId) {
        const canvas = document.getElementById(`chart-${chartId}`);
        if (!canvas) return;
        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = `theTowerStats-${chartId}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      for (const btn of document.querySelectorAll(".download-chart-png")) {
        btn.addEventListener("click", function () {
          downloadChartPng(btn.dataset.chartId);
        });
      }
    </script>

    <div class="modal-backdrop" id="chart-builder-modal" aria-hidden="true">
      <div class="modal-shell" role="dialog" aria-modal="true" aria-label="Chart Builder">
        <div class="grid-x grid-margin-x align-middle">
          <div class="cell auto">
            <h4 class="margin-0">Chart Builder</h4>
            <p class="muted margin-0">Build a constrained chart from registered metrics.</p>
          </div>
          <div class="cell shrink">
            <button class="button secondary" type="button" id="close-chart-builder">Close</button>
          </div>
        </div>

        {% if chart_builder_errors %}
          <div class="callout alert margin-top-1">
            <p class="margin-0"><strong>Chart Builder validation</strong></p>
            <ul class="margin-bottom-0">
              {% for err in chart_builder_errors %}
                <li>{{ err }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <div class="margin-top-1">
          <div class="callout warning" id="builder-constraints" hidden>
            <p class="margin-0"><strong>Selection constraints</strong></p>
            <p class="margin-0" id="builder-constraints-text"></p>
          </div>

          <h5 class="margin-bottom-0">Step 1 — Metrics</h5>
          <p class="muted margin-top-0">Metrics determine the unit and constraints for the chart.</p>
          <label>{{ chart_builder_form.metric_keys.label }}
            {{ chart_builder_form.metric_keys }}
          </label>

          <div id="builder-step-2" class="margin-top-1" hidden>
            <h5 class="margin-bottom-0">Step 2 — Chart settings</h5>
            <p class="muted margin-top-0">Chart type and grouping apply to the selected metrics.</p>
            <div class="grid-x grid-margin-x">
              <div class="cell medium-4">
                <label>{{ chart_builder_form.chart_type.label }}
                  {{ chart_builder_form.chart_type }}
                </label>
              </div>
              <div class="cell medium-4">
                <label>{{ chart_builder_form.group_by.label }}
                  {{ chart_builder_form.group_by }}
                </label>
              </div>
              <div class="cell medium-4">
                <label>{{ chart_builder_form.smoothing.label }}
                  {{ chart_builder_form.smoothing }}
                </label>
              </div>
            </div>
          </div>

          <div id="builder-step-3" class="margin-top-1" hidden>
            <h5 class="margin-bottom-0">Step 3 — Comparison (optional)</h5>
            <p class="muted margin-top-0">Comparison fields appear based on the selected mode.</p>
            <label>{{ chart_builder_form.comparison.label }}
              {{ chart_builder_form.comparison }}
            </label>

            <div class="grid-x grid-margin-x">
              <div class="cell medium-6">
                <label>{{ chart_builder_form.run_a.label }}
                  {{ chart_builder_form.run_a }}
                </label>
              </div>
              <div class="cell medium-6">
                <label>{{ chart_builder_form.run_b.label }}
                  {{ chart_builder_form.run_b }}
                </label>
              </div>
            </div>

            <div class="grid-x grid-margin-x">
              <div class="cell medium-6">
                <label>{{ chart_builder_form.window_a_start.label }}
                  {{ chart_builder_form.window_a_start }}
                </label>
                <label>{{ chart_builder_form.window_a_end.label }}
                  {{ chart_builder_form.window_a_end }}
                </label>
              </div>
              <div class="cell medium-6">
                <label>{{ chart_builder_form.window_b_start.label }}
                  {{ chart_builder_form.window_b_start }}
                </label>
                <label>{{ chart_builder_form.window_b_end.label }}
                  {{ chart_builder_form.window_b_end }}
                </label>
              </div>
            </div>
          </div>

          <div id="builder-step-4" class="margin-top-1" hidden>
            <h5 class="margin-bottom-0">Step 4 — Apply</h5>
            <p class="muted margin-top-0">Applies the selection to the dashboard URL parameters.</p>
            <div class="button-group expanded stack-for-small">
              <button class="button" type="button" id="apply-chart-builder">Apply to dashboard</button>
              <a class="button secondary" href="{% url 'core:dashboard' %}">Clear builder</a>
            </div>
          </div>

          <hr>

          <h5 class="margin-bottom-0">Snapshots</h5>
          <p class="muted">Snapshots save a Chart Builder configuration and the context filters used at the time of saving.</p>

          <label>Load snapshot
            <select id="snapshot-select">
              <option value="">(select)</option>
              {% for snapshot in chart_snapshots %}
                <option value="{{ snapshot.id }}">{{ snapshot.name }}</option>
              {% endfor %}
            </select>
          </label>
          <div class="button-group expanded stack-for-small">
            <button class="button secondary" type="button" id="load-snapshot">Load snapshot</button>
          </div>

          {% if demo_mode %}
            <div class="callout warning margin-top-1" role="status">
              Snapshots are disabled in demo mode.
            </div>
          {% else %}
            <form method="post" id="snapshot-save-form" class="margin-top-1">
              {% csrf_token %}
              <input type="hidden" name="action" value="create_chart_snapshot">
              <label>Snapshot name
                <input type="text" name="snapshot_name" maxlength="120" placeholder="e.g. Before unlocking X">
              </label>
              <label>Snapshot target
                <select name="snapshot_target">
                  <option value="charts">Charts</option>
                  <option value="ultimate_weapons">Ultimate Weapons</option>
                </select>
              </label>
              <input type="hidden" name="chart_type" id="snapshot-chart-type-hidden" value="">
              <input type="hidden" name="group_by" id="snapshot-group-by-hidden" value="">
              <input type="hidden" name="comparison" id="snapshot-comparison-hidden" value="">
              <input type="hidden" name="smoothing" id="snapshot-smoothing-hidden" value="">
              <input type="hidden" name="run_a" id="snapshot-run-a-hidden" value="">
              <input type="hidden" name="run_b" id="snapshot-run-b-hidden" value="">
              <input type="hidden" name="window_a_start" id="snapshot-window-a-start-hidden" value="">
              <input type="hidden" name="window_a_end" id="snapshot-window-a-end-hidden" value="">
              <input type="hidden" name="window_b_start" id="snapshot-window-b-start-hidden" value="">
              <input type="hidden" name="window_b_end" id="snapshot-window-b-end-hidden" value="">
              <div id="snapshot-metric-keys-hidden"></div>
              <button class="button expanded" type="submit">Save snapshot</button>
            </form>
          {% endif %}
        </div>
      </div>
    </div>

    <script>
      (function() {
        const modal = document.getElementById("chart-builder-modal");
        const openBtn = document.getElementById("open-chart-builder");
        const closeBtn = document.getElementById("close-chart-builder");
        const applyBtn = document.getElementById("apply-chart-builder");
        const contextForm = document.getElementById("chart-context-form");

        function openModal() {
          if (!modal) return;
          modal.classList.add("is-open");
          modal.setAttribute("aria-hidden", "false");
        }

        function closeModal() {
          if (!modal) return;
          modal.classList.remove("is-open");
          modal.setAttribute("aria-hidden", "true");
        }

        if (openBtn) openBtn.addEventListener("click", openModal);
        if (closeBtn) closeBtn.addEventListener("click", closeModal);
        if (modal) {
          modal.addEventListener("click", function(ev) {
            if (ev.target === modal) closeModal();
          });
        }

        function setHidden(id, value) {
          const el = document.getElementById(id);
          if (!el) return;
          el.value = value == null ? "" : String(value);
        }

        function syncMetricHidden(selected) {
          const container = document.getElementById("builder-metric-keys-hidden");
          if (!container) return;
          container.innerHTML = "";
          for (const key of selected) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "metric_keys";
            input.value = key;
            container.appendChild(input);
          }
        }

        function syncMetricHiddenTo(containerId, selected) {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.innerHTML = "";
          for (const key of selected) {
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "metric_keys";
            input.value = key;
            container.appendChild(input);
          }
        }

        function applyBuilder() {
          if (!contextForm) return;

          const chartType = document.querySelector("#chart-builder-modal [name='chart_type']");
          const groupBy = document.querySelector("#chart-builder-modal [name='group_by']");
          const comparison = document.querySelector("#chart-builder-modal [name='comparison']");
          const smoothing = document.querySelector("#chart-builder-modal [name='smoothing']");
          const runA = document.querySelector("#chart-builder-modal [name='run_a']");
          const runB = document.querySelector("#chart-builder-modal [name='run_b']");
          const aStart = document.querySelector("#chart-builder-modal [name='window_a_start']");
          const aEnd = document.querySelector("#chart-builder-modal [name='window_a_end']");
          const bStart = document.querySelector("#chart-builder-modal [name='window_b_start']");
          const bEnd = document.querySelector("#chart-builder-modal [name='window_b_end']");
          const metrics = document.querySelector("#chart-builder-modal [name='metric_keys']");

          const selectedMetricKeys = [];
          if (metrics && metrics.options) {
            for (const option of metrics.options) {
              if (option.selected) selectedMetricKeys.push(option.value);
            }
          }

          setHidden("builder-flag", "1");
          setHidden("builder-chart-type-hidden", chartType ? chartType.value : "");
          setHidden("builder-group-by-hidden", groupBy ? groupBy.value : "");
          setHidden("builder-comparison-hidden", comparison ? comparison.value : "");
          setHidden("builder-smoothing-hidden", smoothing ? smoothing.value : "");
          setHidden("builder-run-a-hidden", runA ? runA.value : "");
          setHidden("builder-run-b-hidden", runB ? runB.value : "");
          setHidden("builder-window-a-start-hidden", aStart ? aStart.value : "");
          setHidden("builder-window-a-end-hidden", aEnd ? aEnd.value : "");
          setHidden("builder-window-b-start-hidden", bStart ? bStart.value : "");
          setHidden("builder-window-b-end-hidden", bEnd ? bEnd.value : "");
          syncMetricHidden(selectedMetricKeys);

          contextForm.submit();
        }

        if (applyBtn) applyBtn.addEventListener("click", applyBuilder);

        const loadSnapshotBtn = document.getElementById("load-snapshot");
        const snapshotSelect = document.getElementById("snapshot-select");
        if (loadSnapshotBtn && snapshotSelect) {
          loadSnapshotBtn.addEventListener("click", function() {
            const selected = snapshotSelect.value;
            if (!selected) return;
            const url = new URL(window.location.href);
            url.searchParams.set("snapshot_id", selected);
            window.location.href = url.toString();
          });
        }

        const snapshotForm = document.getElementById("snapshot-save-form");
        if (snapshotForm) {
          snapshotForm.addEventListener("submit", function() {
            const chartType = document.querySelector("#chart-builder-modal [name='chart_type']");
            const groupBy = document.querySelector("#chart-builder-modal [name='group_by']");
            const comparison = document.querySelector("#chart-builder-modal [name='comparison']");
            const smoothing = document.querySelector("#chart-builder-modal [name='smoothing']");
            const runA = document.querySelector("#chart-builder-modal [name='run_a']");
            const runB = document.querySelector("#chart-builder-modal [name='run_b']");
            const aStart = document.querySelector("#chart-builder-modal [name='window_a_start']");
            const aEnd = document.querySelector("#chart-builder-modal [name='window_a_end']");
            const bStart = document.querySelector("#chart-builder-modal [name='window_b_start']");
            const bEnd = document.querySelector("#chart-builder-modal [name='window_b_end']");
            const metrics = document.querySelector("#chart-builder-modal [name='metric_keys']");

            const selectedMetricKeys = [];
            if (metrics && metrics.options) {
              for (const option of metrics.options) {
                if (option.selected) selectedMetricKeys.push(option.value);
              }
            }

            setHidden("snapshot-chart-type-hidden", chartType ? chartType.value : "");
            setHidden("snapshot-group-by-hidden", groupBy ? groupBy.value : "");
            setHidden("snapshot-comparison-hidden", comparison ? comparison.value : "");
            setHidden("snapshot-smoothing-hidden", smoothing ? smoothing.value : "");
            setHidden("snapshot-run-a-hidden", runA ? runA.value : "");
            setHidden("snapshot-run-b-hidden", runB ? runB.value : "");
            setHidden("snapshot-window-a-start-hidden", aStart ? aStart.value : "");
            setHidden("snapshot-window-a-end-hidden", aEnd ? aEnd.value : "");
            setHidden("snapshot-window-b-start-hidden", bStart ? bStart.value : "");
            setHidden("snapshot-window-b-end-hidden", bEnd ? bEnd.value : "");
            syncMetricHiddenTo("snapshot-metric-keys-hidden", selectedMetricKeys);
          });
        }

        const metricsSelect = document.querySelector("#chart-builder-modal [name='metric_keys']");
        const chartTypeSelect = document.querySelector("#chart-builder-modal [name='chart_type']");
        const groupBySelect = document.querySelector("#chart-builder-modal [name='group_by']");
        const comparisonSelect = document.querySelector("#chart-builder-modal [name='comparison']");
        const smoothingSelect = document.querySelector("#chart-builder-modal [name='smoothing']");
        const constraintsBox = document.getElementById("builder-constraints");
        const constraintsText = document.getElementById("builder-constraints-text");
        const runASelect = document.querySelector("#chart-builder-modal [name='run_a']");
        const runBSelect = document.querySelector("#chart-builder-modal [name='run_b']");
        const windowInputs = [
          document.querySelector("#chart-builder-modal [name='window_a_start']"),
          document.querySelector("#chart-builder-modal [name='window_a_end']"),
          document.querySelector("#chart-builder-modal [name='window_b_start']"),
          document.querySelector("#chart-builder-modal [name='window_b_end']"),
        ];
        const step2 = document.getElementById("builder-step-2");
        const step3 = document.getElementById("builder-step-3");
        const step4 = document.getElementById("builder-step-4");

        function selectedMetricCount() {
          let count = 0;
          if (!metricsSelect || !metricsSelect.options) return 0;
          for (const option of metricsSelect.options) if (option.selected) count += 1;
          return count;
        }

        function updateChartTypeConstraints() {
          if (!chartTypeSelect) return;
          const donutOption = Array.from(chartTypeSelect.options || []).find((o) => o.value === "donut");
          if (!donutOption) return;
          donutOption.disabled = selectedMetricCount() < 2;
          if (donutOption.disabled && chartTypeSelect.value === "donut") {
            chartTypeSelect.value = "line";
          }
        }

        function enforceSchemaConstraints() {
          const chartType = chartTypeSelect ? chartTypeSelect.value : "line";
          const comparison = comparisonSelect ? comparisonSelect.value : "none";
          const donutSelected = chartType === "donut";
          const comparisonActive = comparison !== "none";

          if (comparisonActive && chartTypeSelect) {
            const donutOption = Array.from(chartTypeSelect.options || []).find((o) => o.value === "donut");
            if (donutOption) donutOption.disabled = true;
            if (chartTypeSelect.value === "donut") chartTypeSelect.value = "line";
          }

          if (donutSelected) {
            if (groupBySelect) {
              groupBySelect.value = "time";
              groupBySelect.disabled = true;
            }
            if (comparisonSelect) {
              comparisonSelect.value = "none";
              comparisonSelect.disabled = true;
            }
            if (smoothingSelect) {
              smoothingSelect.value = "none";
              smoothingSelect.disabled = true;
            }
            return;
          }

          if (comparisonActive) {
            if (groupBySelect) {
              groupBySelect.value = "time";
              groupBySelect.disabled = true;
            }
          } else if (groupBySelect) {
            groupBySelect.disabled = false;
          }

          if (comparisonSelect) comparisonSelect.disabled = false;
          if (smoothingSelect) smoothingSelect.disabled = false;
        }

        function setConstraintMessage(message) {
          if (!constraintsBox || !constraintsText) return;
          if (!message) {
            constraintsBox.hidden = true;
            constraintsText.textContent = "";
            return;
          }
          constraintsBox.hidden = false;
          constraintsText.textContent = message;
        }

        function updateMetricCompatibility() {
          const apply = document.getElementById("apply-chart-builder");
          if (!apply) return;
          const keys = [];
          if (metricsSelect && metricsSelect.options) {
            for (const option of metricsSelect.options) if (option.selected) keys.push(option.value);
          }
          const hasMetrics = keys.length > 0;
          if (step2) step2.hidden = !hasMetrics;
          if (step3) step3.hidden = !hasMetrics;
          if (step4) step4.hidden = !hasMetrics;

          if (!keys.length) {
            if (chartTypeSelect) chartTypeSelect.disabled = true;
            if (groupBySelect) groupBySelect.disabled = true;
            if (comparisonSelect) comparisonSelect.disabled = true;
            if (smoothingSelect) smoothingSelect.disabled = true;
            if (runASelect) runASelect.disabled = true;
            if (runBSelect) runBSelect.disabled = true;
            for (const input of windowInputs) {
              if (input) input.disabled = true;
            }
            apply.disabled = true;
            setConstraintMessage("Select at least one metric.");
            return;
          }

          if (chartTypeSelect) chartTypeSelect.disabled = false;
          if (comparisonSelect) comparisonSelect.disabled = false;
          if (smoothingSelect) smoothingSelect.disabled = false;
          if (groupBySelect) groupBySelect.disabled = false;
          updateComparisonControls();
          enforceSchemaConstraints();

          if (chartTypeSelect && chartTypeSelect.value === "donut" && keys.length < 2) {
            apply.disabled = true;
            setConstraintMessage("Donut charts require at least two metrics.");
            return;
          }
          let unit = null;
          let category = null;
          for (const key of keys) {
            const meta = chartBuilderMetricMeta[key];
            if (!meta) continue;
            unit = unit || meta.unit;
            category = category || meta.category;
            if (meta.unit !== unit) {
              apply.disabled = true;
              setConstraintMessage("Selected metrics must share the same unit.");
              return;
            }
            if (meta.category !== category) {
              apply.disabled = true;
              setConstraintMessage("Selected metrics must share the same category.");
              return;
            }
          }
          if (smoothingSelect && smoothingSelect.value === "rolling_avg") {
            const unsupported = keys.filter((k) => chartBuilderMetricMeta[k] && !chartBuilderMetricMeta[k].supports_rolling_avg);
            if (unsupported.length) {
              apply.disabled = true;
              setConstraintMessage(`Rolling average is not supported for: ${unsupported.join(", ")}`);
              return;
            }
          }
          apply.disabled = false;
          setConstraintMessage("");
        }

        function updateComparisonControls() {
          const mode = comparisonSelect ? comparisonSelect.value : "none";
          const enableRuns = mode === "run_vs_run";
          const enableWindows = mode === "before_after";
          if (runASelect) runASelect.disabled = !enableRuns;
          if (runBSelect) runBSelect.disabled = !enableRuns;
          for (const input of windowInputs) {
            if (input) input.disabled = !enableWindows;
          }
        }

        if (metricsSelect) metricsSelect.addEventListener("change", () => { updateChartTypeConstraints(); updateMetricCompatibility(); });
        if (chartTypeSelect) chartTypeSelect.addEventListener("change", updateMetricCompatibility);
        if (groupBySelect) groupBySelect.addEventListener("change", updateMetricCompatibility);
        if (comparisonSelect) comparisonSelect.addEventListener("change", () => { updateComparisonControls(); updateMetricCompatibility(); });
        if (smoothingSelect) smoothingSelect.addEventListener("change", updateMetricCompatibility);
        updateChartTypeConstraints();
        updateComparisonControls();
        updateMetricCompatibility();
        {% if chart_builder_errors %}
          openModal();
        {% endif %}
      })();
    </script>

    <script>
      (function() {
        const mode = document.getElementById("advice-mode");
        const b = document.getElementById("advice-snapshot-b");
        function updateAdviceControls() {
          if (!mode || !b) return;
          b.disabled = mode.value !== "snapshot_vs_snapshot";
        }
        if (mode) mode.addEventListener("change", updateAdviceControls);
        updateAdviceControls();
      })();
    </script>

    <script>
      (function() {
        const intent = document.getElementById("goal-intent");
        const wCph = document.getElementById("goal-weight-coins-per-hour");
        const wCpw = document.getElementById("goal-weight-coins-per-wave");
        const wWaves = document.getElementById("goal-weight-waves-reached");

        const presets = {
          economy: { cph: 1.0, cpw: 0.5, waves: 0.25 },
          progression: { cph: 0.25, cpw: 0.25, waves: 1.0 },
          hybrid: { cph: 0.75, cpw: 0.5, waves: 0.75 },
        };

        function applyPreset(key) {
          const preset = presets[key] || presets.hybrid;
          if (wCph) wCph.value = String(preset.cph);
          if (wCpw) wCpw.value = String(preset.cpw);
          if (wWaves) wWaves.value = String(preset.waves);
        }

        if (intent) intent.addEventListener("change", () => applyPreset(intent.value));
      })();
    </script>
{% endblock %}
