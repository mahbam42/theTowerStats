{% extends "core/base.html" %}

{% block title %}Charts • theTowerStats{% endblock %}

{% block head %}
  <style>
    .chart-panel canvas {
      max-width: 100%;
    }

    .chart-shell {
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
    }
  </style>
{% endblock %}

{% block content %}
  <div class="grid-x grid-margin-x">
    <div class="cell">
      <div class="card-shell">
        <div class="grid-x grid-margin-x align-middle">
          <div class="cell auto">
            <p class="muted margin-0">Charts</p>
            <h2 class="margin-0">{{ metric_definition.label }}</h2>
            <p class="muted margin-0">Filters default to December 9, 2025 to focus on recent runs.</p>
          </div>
          <div class="cell shrink text-right">
            <a class="button" href="{% url 'core:battle_history' %}">View history</a>
            <p class="muted text-right margin-0">Use the Battle History dashboard to paste new runs.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="grid-x grid-margin-x">
    <div class="cell large-3 medium-4">
      <div class="card-shell">
        <h4 class="margin-bottom-1">Filters</h4>
        <form method="get" id="chart-context-form">
          <label>Metric / Chart
            {{ chart_form.metric }}
          </label>
          <label>Start date
            {{ chart_form.start_date }}
          </label>
          <label>End date
            {{ chart_form.end_date }}
          </label>
          <label>Tier
            {{ chart_form.tier }}
          </label>
          <label>Preset
            {{ chart_form.preset }}
          </label>
          <label>Overlay
            {{ chart_form.overlay_group }}
          </label>
          <label>Moving average window
            {{ chart_form.moving_average_window }}
          </label>
          <div class="button-group expanded stack-for-small margin-top-1">
            <button class="button" type="submit">Apply</button>
            <a class="button secondary" href="{% url 'core:dashboard' %}">Clear</a>
          </div>
        </form>
      </div>

      <div class="card-shell margin-top-1">
        <h5>Compare</h5>
        <form method="get">
          {{ comparison_form.as_p }}
          <button class="button hollow" type="submit">Compare</button>
        </form>
      </div>

      <div class="card-shell margin-top-1">
        <h5>Quick import</h5>
        <form method="post">
          {% csrf_token %}
          <label>{{ import_form.raw_text.label }}
            {{ import_form.raw_text }}
          </label>
          <label>{{ import_form.preset_name.label }}
            {{ import_form.preset_name }}
          </label>
          <button class="button expanded" type="submit">Import Battle Report</button>
        </form>
      </div>
    </div>

    <div class="cell large-9 medium-8">
      <div class="callout primary context-bar" aria-live="polite">
        <strong>Active context</strong>
        <div id="active-context" class="muted"></div>
      </div>

      {% if metric_definition.kind == "derived" %}
        <div class="callout secondary">
          <p class="margin-0"><strong>Derived metric transparency</strong></p>
          {% if metric_assumptions %}
            <ul class="margin-bottom-0">
              {% for assumption in metric_assumptions %}
                <li>{{ assumption }}</li>
              {% endfor %}
            </ul>
          {% endif %}
          {% if used_parameters %}
            <details class="margin-top-1">
              <summary>Parameters referenced</summary>
              <ul>
                {% for param in used_parameters %}
                  <li>
                    {{ param.entity_type }} • {{ param.entity_name }} • {{ param.key }} = {{ param.raw_value }}
                    {% if param.wiki_revision_id %}(wiki rev {{ param.wiki_revision_id }}){% endif %}
                  </li>
                {% endfor %}
              </ul>
            </details>
          {% endif %}
        </div>
      {% endif %}

      {% if comparison_result %}
        <div class="callout success">
          <p class="margin-0"><strong>Deltas ({{ comparison_result.metric }})</strong></p>
          {% if comparison_result.kind == "runs" %}
            <p class="margin-0">
              Baseline: Run A ({{ comparison_result.label_a }}) • Comparison: Run B ({{ comparison_result.label_b }})
            </p>
          {% else %}
            <p class="margin-0">
              Baseline: Window A ({{ comparison_result.window_a.start_date }} to {{ comparison_result.window_a.end_date }})
              • Comparison: Window B ({{ comparison_result.window_b.start_date }} to {{ comparison_result.window_b.end_date }})
            </p>
          {% endif %}
          <ul class="margin-bottom-0">
            <li>Baseline: {{ comparison_result.baseline_value|floatformat:2 }} {{ comparison_result.metric }}</li>
            <li>Comparison: {{ comparison_result.comparison_value|floatformat:2 }} {{ comparison_result.metric }}</li>
            <li>Absolute: {{ comparison_result.delta.absolute|floatformat:2 }}</li>
            {% if comparison_result.percent_display is not None %}
              <li>Percent: {{ comparison_result.percent_display|floatformat:2 }}%</li>
            {% else %}
              <li>Percent: n/a (baseline is 0)</li>
            {% endif %}
          </ul>
        </div>
      {% endif %}

      {% if chart_empty_state %}
        <div class="empty-state" role="status">{{ chart_empty_state }}</div>
      {% endif %}

      {% if metric_definition.kind == "derived" %}
        <div class="grid-x grid-margin-x" {% if chart_empty_state %}hidden{% endif %}>
          <div class="cell">
            <div class="chart-shell">
              <div class="grid-x align-justify align-middle">
                <div class="cell auto">
                  <h4 class="margin-0">{{ metric_definition.label }} <span class="muted">({{ metric_definition.unit }})</span></h4>
                </div>
              </div>
              <canvas id="chart-primary" width="900" height="350"></canvas>
            </div>
          </div>
          {% if secondary_metric_definition %}
            <div class="cell margin-top-1">
              <div class="chart-shell">
                <div class="grid-x align-justify align-middle">
                  <div class="cell auto">
                    <h4 class="margin-0">{{ secondary_metric_definition.label }} <span class="muted">({{ secondary_metric_definition.unit }})</span></h4>
                  </div>
                </div>
                <canvas id="chart-secondary" width="900" height="350"></canvas>
              </div>
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="chart-shell" {% if chart_empty_state %}hidden{% endif %}>
          <div class="grid-x align-justify align-middle">
            <div class="cell auto">
              <h4 class="margin-0">{{ metric_definition.label }} <span class="muted">({{ metric_definition.unit }})</span></h4>
            </div>
          </div>
          <canvas id="chart-primary" width="900" height="350"></canvas>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      const primaryLabels = {{ chart_labels_json|safe }};
      const primaryDatasets = {{ chart_datasets_json|safe }};
      const secondaryLabels = {{ secondary_chart_labels_json|safe }};
      const secondaryDatasets = {{ secondary_chart_datasets_json|safe }};
      const initialContext = {{ chart_context_json|safe }};

      function formatCompactNumber(value) {
        const absValue = Math.abs(Number(value));
        if (!Number.isFinite(absValue)) return String(value);
        if (absValue >= 1_000_000_000) return (value / 1_000_000_000).toFixed(2) + "B";
        if (absValue >= 1_000_000) return (value / 1_000_000).toFixed(2) + "M";
        if (absValue >= 1_000) return (value / 1_000).toFixed(2) + "K";
        return String(value);
      }

      function formatExactNumber(value) {
        const num = Number(value);
        if (!Number.isFinite(num)) return String(value);
        return new Intl.NumberFormat(undefined, { maximumFractionDigits: 2 }).format(num);
      }

      function readChartContextFromDOM() {
        const form = document.getElementById("chart-context-form");
        if (!form) return initialContext;

        const getValue = (name) => {
          const el = form.elements[name];
          if (!el) return null;
          if (el.value === "") return null;
          return el.value;
        };

        const presetEl = form.elements["preset"];
        const presetLabel =
          presetEl && presetEl.selectedIndex >= 0 ? presetEl.options[presetEl.selectedIndex].text : null;

        const metricEl = form.elements["metric"];
        const metricLabel =
          metricEl && metricEl.selectedIndex >= 0 ? metricEl.options[metricEl.selectedIndex].text : null;

        return {
          metric: metricLabel || getValue("metric"),
          start_date: getValue("start_date"),
          end_date: getValue("end_date"),
          tier: getValue("tier"),
          preset: presetLabel && presetLabel !== "All presets" ? presetLabel : null,
          overlay_group: getValue("overlay_group") || "none",
          moving_average_window: getValue("moving_average_window"),
        };
      }

      function contextLabel(context) {
        const start = context.start_date || "Any start";
        const end = context.end_date || "Any end";
        const metric = context.metric ? `Metric: ${context.metric}` : "Metric: (default)";
        const tier = context.tier ? `Tier ${context.tier}` : "All tiers";
        const preset = context.preset ? `Preset: ${context.preset}` : "All presets";
        const overlay =
          context.overlay_group && context.overlay_group !== "none"
            ? `Overlay: ${context.overlay_group}`
            : "Overlay: none";
        const ma = context.moving_average_window ? `Moving average: ${context.moving_average_window}` : "Moving average: off";
        return `${metric} • ${tier} • ${preset} • ${start} → ${end} • ${overlay} • ${ma}`;
      }

      function updateContextSummary() {
        const el = document.getElementById("active-context");
        if (!el) return;
        el.textContent = contextLabel(readChartContextFromDOM());
      }

      updateContextSummary();
      const chartContextForm = document.getElementById("chart-context-form");
      if (chartContextForm) {
        chartContextForm.addEventListener("input", updateContextSummary);
        chartContextForm.addEventListener("change", updateContextSummary);
      }

      function renderLineChart(canvasId, labels, datasets) {
        const canvas = document.getElementById(canvasId);
        const ctx = canvas ? canvas.getContext("2d") : null;
        if (!ctx || labels.length === 0 || datasets.length === 0) return;
        new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets,
          },
          options: {
            responsive: true,
            interaction: { mode: "nearest", intersect: false },
            plugins: {
              legend: {
                display: true,
                labels: { usePointStyle: true },
                onClick: (_event, legendItem, legend) => {
                  const datasetIndex = legendItem?.datasetIndex;
                  if (typeof datasetIndex !== "number") return;
                  const chart = legend?.chart;
                  if (!chart) return;
                  chart.setDatasetVisibility(datasetIndex, !chart.isDatasetVisible(datasetIndex));
                  chart.update();
                },
              },
              tooltip: {
                callbacks: {
                  title: (items) => (items && items[0] ? `Date: ${items[0].label}` : ""),
                  label: (context) => {
                    const datasetLabel = context.dataset?.label || "Series";
                    const unit = context.dataset?.unit || "";
                    const unitLabel = unit ? ` ${unit}` : "";
                    return `${datasetLabel}: ${formatExactNumber(context.parsed.y)}${unitLabel}`;
                  },
                  afterBody: () => {
                    const context = readChartContextFromDOM();
                    const lines = [];
                    if (context.tier) lines.push(`Filter tier: ${context.tier}`);
                    if (context.preset) lines.push(`Filter preset: ${context.preset}`);
                    if (context.start_date || context.end_date) {
                      lines.push(`Date range: ${context.start_date || "…"} → ${context.end_date || "…"}`);
                    }
                    if (context.overlay_group && context.overlay_group !== "none") {
                      lines.push(`Overlay: ${context.overlay_group}`);
                    }
                    if (context.moving_average_window) {
                      lines.push(`Moving average window: ${context.moving_average_window}`);
                    }
                    return lines;
                  },
                },
              },
            },
            scales: {
              x: {
                title: { display: true, text: "Date" },
                ticks: { maxRotation: 0, autoSkip: true },
              },
              y: {
                beginAtZero: true,
                title: { display: true, text: datasets[0]?.unit || "Value" },
                ticks: {
                  callback: (value) => formatCompactNumber(value),
                },
              },
            },
          },
        });
      }

      // Empty state is rendered server-side.
      renderLineChart("chart-primary", primaryLabels, primaryDatasets);
      renderLineChart("chart-secondary", secondaryLabels, secondaryDatasets);
    </script>
{% endblock %}
