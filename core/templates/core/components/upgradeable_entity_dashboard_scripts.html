<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }

  function parseNumber(raw) {
    if (!raw) return null;
    const match = String(raw).replaceAll(',', '').match(/([+-]?[0-9]+(?:\.[0-9]+)?)/);
    if (!match) return null;
    const parsed = Number(match[1]);
    return Number.isFinite(parsed) ? parsed : null;
  }

  function formatDelta(currentRaw, nextRaw, unitKind) {
    const currentNum = parseNumber(currentRaw);
    const nextNum = parseNumber(nextRaw);
    if (currentNum === null || nextNum === null) return null;
    const delta = nextNum - currentNum;
    if (delta === 0) return null;
    const sign = delta > 0 ? '+' : '−';
    const magnitude = Math.abs(delta);
    let suffix = '';
    if (unitKind === 'seconds') suffix = 's';
    if (unitKind === 'percent') suffix = '%';
    if (unitKind === 'multiplier') suffix = 'x';
    return `${sign}${magnitude}${suffix}`;
  }

  function jsonScript(id) {
    const el = document.getElementById(id);
    if (!el) return null;
    try { return JSON.parse(el.textContent); } catch (e) { return null; }
  }

  function clearNode(node) {
    while (node.firstChild) node.removeChild(node.firstChild);
  }

  function setMutedDash(cell) {
    if (!cell) return;
    clearNode(cell);
    const span = document.createElement('span');
    span.className = 'muted';
    span.textContent = '—';
    cell.appendChild(span);
  }

  function setValueWithDelta(cell, valueRaw, deltaText) {
    if (!cell) return;
    clearNode(cell);
    if (valueRaw) cell.appendChild(document.createTextNode(valueRaw));
    if (deltaText) {
      if (valueRaw) cell.appendChild(document.createTextNode(' '));
      const strong = document.createElement('strong');
      strong.className = 'entity-param-delta';
      strong.textContent = `(${deltaText})`;
      cell.appendChild(strong);
    }
  }

  function postForm(form) {
    const data = new FormData(form);
    const token = data.get('csrfmiddlewaretoken') || getCookie('csrftoken');
    const target = form.getAttribute('action') || window.location.href;
    return fetch(target, {
      method: 'POST',
      credentials: 'same-origin',
      headers: {
        'X-CSRFToken': token || '',
        'X-Requested-With': 'XMLHttpRequest',
      },
      body: data,
    });
  }

  document.addEventListener('change', function (event) {
    const input = event.target;
    if (!input.classList || !input.classList.contains('entity-active-toggle')) return;
    const form = input.closest('form');
    if (!form) return;
    if (typeof form.requestSubmit === 'function') form.requestSubmit();
    else form.submit();
  });

  document.addEventListener('submit', async function (event) {
    const form = event.target;
    if (!form.classList.contains('entity-action-form')) return;
    const action = form.dataset.action;
    if (action === 'toggle_active') return;
    event.preventDefault();

    const tile = form.closest('.entity-tile');
    if (!tile) return;

    if (action === 'unlock') {
      const button = form.querySelector('button');
      if (button) button.disabled = true;

      tile.classList.remove('secondary');
      tile.classList.add('success');
      const status = tile.querySelector('.entity-status');
      if (status) status.textContent = 'Unlocked';
      const lockedPanel = tile.querySelector('.entity-locked-panel');
      if (lockedPanel) lockedPanel.innerHTML = '<p class="muted margin-0">Unlocking…</p>';

      try {
        const resp = await postForm(form);
        const payload = await resp.json();
        if (!resp.ok || !payload.ok) throw new Error(payload.error || 'Unlock failed.');
        window.location.reload();
      } catch (err) {
        window.location.reload();
      }
      return;
    }

    if (action === 'level_down') {
      const button = form.querySelector('button');
      if (button) button.disabled = true;

      try {
        const resp = await postForm(form);
        const payload = await resp.json();
        if (!resp.ok || !payload.ok) throw new Error(payload.error || 'Decrease failed.');
        window.location.reload();
      } catch (err) {
        window.location.reload();
      }
      return;
    }

    if (action === 'level_up') {
      const row = tile.querySelector(`.entity-param-row[data-param-id="${form.dataset.paramId}"]`);
      if (!row) return;
      const button = form.querySelector('button');
      if (button) button.disabled = true;

      const unitKind = row.dataset.unitKind;
      const levelCell = row.querySelector('.entity-param-level');
      const currentCell = row.querySelector('.entity-param-current');
      const effectiveCell = row.querySelector('.entity-param-effective-value');
      const nextCell = row.querySelector('.entity-param-next');
      const costCell = row.querySelector('.entity-param-cost');
      const totalInvestedEl = tile.querySelector('.entity-total-invested');

      const old = {
        level: levelCell ? levelCell.textContent : '',
        current: currentCell ? currentCell.textContent : '',
        next: nextCell ? nextCell.textContent : '',
        cost: costCell ? costCell.textContent : '',
        total: totalInvestedEl ? totalInvestedEl.textContent : '',
      };

      const currentLevel = Number(row.dataset.level || 0);
      const levels = jsonScript(`param-levels-${form.dataset.paramId}`) || [];
      const currentRow = levels.find(r => r.level === currentLevel);
      const nextRow = levels.find(r => r.level === currentLevel + 1);
      const nextNextRow = levels.find(r => r.level === currentLevel + 2);
      const upgradeCostRaw = currentRow ? currentRow.cost_raw : null;

      if (nextRow) {
        row.dataset.level = String(currentLevel + 1);
        if (levelCell) levelCell.textContent = String(currentLevel + 1);
        const previousBase = currentCell ? currentCell.textContent : '';
        const previousEffective = effectiveCell ? effectiveCell.textContent : '';
        if (currentCell) currentCell.textContent = nextRow.value_raw || '';
        if (effectiveCell && previousEffective && previousEffective.trim() === previousBase.trim()) {
          effectiveCell.textContent = nextRow.value_raw || '';
        }

        if (nextCell) {
          if (nextNextRow) {
            const delta = formatDelta(nextRow.value_raw, nextNextRow.value_raw, unitKind);
            setValueWithDelta(nextCell, nextNextRow.value_raw || '', delta);
          } else {
            setMutedDash(nextCell);
          }
        }

        if (costCell) {
          if (nextNextRow) {
            costCell.textContent = nextRow.cost_raw || '';
          } else {
            setMutedDash(costCell);
          }
        }

        if (totalInvestedEl) {
          const parsed = parseNumber(upgradeCostRaw);
          const currentTotal = parseNumber(totalInvestedEl.textContent) || 0;
          if (parsed !== null) totalInvestedEl.textContent = String(currentTotal + parsed);
        }
      }

      try {
        const resp = await postForm(form);
        const payload = await resp.json();
        if (!resp.ok || !payload.ok) throw new Error(payload.error || 'Upgrade failed.');
        window.location.reload();
      } catch (err) {
        if (levelCell) levelCell.textContent = old.level;
        if (currentCell) currentCell.textContent = old.current;
        if (nextCell) nextCell.textContent = old.next;
        if (costCell) costCell.textContent = old.cost;
        if (totalInvestedEl) totalInvestedEl.textContent = old.total;
        window.location.reload();
      }
      return;
    }
  });
</script>
