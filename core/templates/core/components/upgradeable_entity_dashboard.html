{# Reusable dashboard pattern for unlockable entities with N upgrade parameters. #}

<div class="grid-x grid-margin-x">
  <div class="cell">
    <div class="card-shell">
      <p class="muted margin-0">{{ dashboard_kicker }}</p>
      <h2 class="margin-0">{{ dashboard_title }}</h2>
      <p class="muted margin-0">{{ dashboard_note }}</p>
    </div>
  </div>
</div>

{% if hero_enabled %}
  <div class="grid-x grid-margin-x margin-top-1">
    <div class="cell">
      <div class="card-shell">
        <p class="muted margin-0">{{ hero_kicker|default:"Overview" }}</p>
        <h4 class="margin-0">{{ hero_title|default:"Featured" }}</h4>
        {% if hero_note %}
          <p class="muted margin-0">{{ hero_note }}</p>
        {% endif %}
        <div class="grid-x grid-margin-x margin-top-1">
          {% if hero_entities %}
            {% for hero in hero_entities %}
              <div class="cell medium-6">
                <div class="callout success margin-0">
                  <h5 class="margin-0">{{ hero.name }}</h5>
                  {% if hero.subtitle %}
                    <p class="muted margin-0">{{ hero.subtitle }}</p>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="cell">
              <p class="muted margin-0">{{ hero_empty|default:"No selections yet." }}</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
{% endif %}

<div class="grid-x grid-margin-x margin-top-1">
  <div class="cell">
    <form method="get" class="card-shell">
      <div class="grid-x grid-margin-x align-middle">
        <div class="cell medium-4">
          <label class="margin-0">
            {{ filter_form.q.label }}
            {{ filter_form.q }}
          </label>
        </div>
        <div class="cell medium-4">
          <label class="margin-0">
            {{ filter_form.status.label }}
            {{ filter_form.status }}
          </label>
        </div>
        <div class="cell shrink">
          <button class="button" type="submit">Filter</button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="grid-x grid-margin-x margin-top-1">
  <div class="cell">
    {% if entities %}
      {% if show_activation and activation_limit_reached %}
        <div class="callout warning margin-bottom-1" role="status">
          Active limit reached (2 of 2). Inactive guardian chips cannot be activated until you deactivate one.
        </div>
      {% endif %}
      <div class="grid-x grid-margin-x">
        {% for entity in entities %}
          <div class="cell medium-6">
            <div class="callout entity-tile {% if entity.unlocked %}success{% else %}secondary{% endif %}" data-entity-id="{{ entity.id }}">
              <div class="grid-x align-justify align-middle">
                <div class="cell auto">
                  <h5 class="margin-0">
                    {{ entity.name }}
                    {% if entity.wiki_page_url %}
                      <a
                        class="muted"
                        href="{{ entity.wiki_page_url }}"
                        target="_blank"
                        rel="noopener noreferrer"
                        aria-label="Open wiki page for {{ entity.name }} (external)"
                        title="Open wiki page (external)"
                      >
                        Wiki
                      </a>
                    {% endif %}
                  </h5>
                  <p class="muted margin-0">
                    Status:
                    <span class="entity-status">{% if entity.unlocked %}Unlocked{% else %}Locked{% endif %}</span>
                  </p>
                </div>
                {% if show_activation %}
                  <div class="cell shrink">
                    {% if demo_mode %}
                      <label class="margin-0">
                        <input type="checkbox" {% if entity.active %}checked{% endif %} disabled aria-disabled="true" />
                        Active
                      </label>
                    {% else %}
                      <form method="post" action="{{ request.path }}" class="inline entity-action-form" data-action="toggle_active" data-entity-id="{{ entity.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="{{ toggle_active_action_value }}" />
                        <input type="hidden" name="entity_id" value="{{ entity.id }}" />
                        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                        <input type="hidden" name="active" value="0" />
                        <label class="margin-0">
                          <input class="entity-active-toggle" type="checkbox" name="active" value="1" {% if entity.active %}checked{% endif %} {% if entity.toggle_disabled %}disabled aria-disabled="true"{% endif %} />
                          Active
                        </label>
                      </form>
                    {% endif %}
                  </div>
                {% endif %}
                <div class="cell shrink">
                  <span class="label">{{ entity_badge }}</span>
                </div>
              </div>

              <div class="grid-x grid-margin-x margin-top-1">
                <div class="cell">
                  <div class="card-shell">
                    <div class="grid-x grid-margin-x align-middle">
                      <div class="cell auto">
                        <p class="muted margin-0">{{ total_invested_label }}</p>
                        <h5 class="margin-0 entity-total-invested">{{ entity.summary.total_invested }}</h5>
                      </div>
                      <div class="cell auto">
                        <p class="muted margin-0">{{ entity.summary.headline_label }}</p>
                        {% if entity.summary.headline_empty %}
                          <p class="muted margin-0">No battles recorded yet</p>
                        {% else %}
                          <h5 class="margin-0">{{ entity.summary.headline_value }}</h5>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {% if entity.unlocked %}
                <details class="margin-top-1" open>
                  <summary>Details</summary>
                  <table class="stack margin-top-1">
                    <thead>
                      <tr>
                        <th scope="col">Parameter</th>
                        <th scope="col">Level</th>
                        <th scope="col">Base</th>
                        <th scope="col">Effective</th>
                        <th scope="col">Next</th>
                        <th scope="col">Cost</th>
                        <th scope="col"></th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for param in entity.parameters %}
                        {% with param_id_str=param.id|stringformat:"s" %}
                          {% with json_id="param-levels-"|add:param_id_str %}
                            {{ param.levels|json_script:json_id }}
                          {% endwith %}
                        {% endwith %}
                        <tr class="entity-param-row" data-param-id="{{ param.id }}" data-unit-kind="{{ param.unit_kind }}" data-level="{{ param.level }}" data-max-level="{{ param.max_level }}">
                          <td>{{ param.name }}</td>
                          <td class="entity-param-level">{{ param.level }}</td>
                          <td class="entity-param-current">{{ param.base_value_raw }}</td>
                          <td class="entity-param-effective">
                            <span class="entity-param-effective-value">{{ param.effective_value_raw }}</span>
                            {% if param.modifier_explanations %}
                              <details class="entity-effective-details">
                                <summary class="entity-effective-summary" aria-label="Effective Value Breakdown">ⓘ</summary>
                                <div class="callout secondary margin-top-0">
                                  <p class="margin-0"><strong>Effective Value Breakdown</strong></p>
                                  <ul class="margin-top-0 margin-bottom-0">
                                    {% for explanation in param.modifier_explanations %}
                                      <li>{{ explanation.description }}</li>
                                    {% endfor %}
                                  </ul>
                                </div>
                              </details>
                            {% endif %}
                          </td>
                          <td class="entity-param-next">
                            {% if param.next_value_raw %}
                              {{ param.next_value_raw }}
                              {% if param.delta %}
                                <strong class="entity-param-delta">({{ param.delta }})</strong>
                              {% endif %}
                            {% else %}
                              <span class="muted">—</span>
                            {% endif %}
                          </td>
                          <td class="entity-param-cost">
                            {% if param.next_cost_raw %}
                              {{ param.next_cost_raw }}
                            {% else %}
                              <span class="muted">—</span>
                            {% endif %}
                          </td>
                          <td class="text-right">
                            {% if demo_mode %}
                              <button class="button tiny secondary disabled" type="button" disabled aria-disabled="true">Decrease level</button>
                              <button class="button tiny disabled" type="button" disabled aria-disabled="true">{% if param.is_maxed %}MAX{% else %}Level Up{% endif %}</button>
                            {% else %}
                              <form method="post" action="{{ request.path }}" class="inline entity-action-form" data-action="level_down" data-param-id="{{ param.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="{{ level_down_action_value }}" />
                                <input type="hidden" name="param_id" value="{{ param.id }}" />
                                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                <button class="button tiny secondary {% if param.is_min %}disabled{% endif %}" type="submit" {% if param.is_min %}disabled aria-disabled="true"{% endif %}>
                                  Decrease level
                                </button>
                              </form>
                              <form method="post" action="{{ request.path }}" class="inline entity-action-form" data-action="level_up" data-param-id="{{ param.id }}">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="{{ level_up_action_value }}" />
                                <input type="hidden" name="param_id" value="{{ param.id }}" />
                                <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                                <button class="button tiny {% if param.is_maxed %}disabled{% endif %} entity-level-up" type="submit" {% if param.is_maxed %}disabled aria-disabled="true"{% endif %}>
                                  {% if param.is_maxed %}MAX{% else %}Level Up{% endif %}
                                </button>
                              </form>
                            {% endif %}
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </details>
              {% else %}
                <div class="card-shell margin-top-1 entity-locked-panel">
                  <p class="muted margin-0">Unlock cost ({{ unlock_cost_currency_label }})</p>
                  <p class="margin-0">{% if entity.unlock_cost_raw %}{{ entity.unlock_cost_raw }}{% else %}<span class="muted">Not tracked yet</span>{% endif %}</p>
                  {% if entity.description %}
                    <p class="muted margin-top-1 margin-bottom-0">{{ entity.description }}</p>
                  {% endif %}
                  {% if demo_mode %}
                    <p class="muted margin-top-1 margin-bottom-0">Unlocks are disabled in demo mode.</p>
                  {% else %}
                    <form method="post" action="{{ request.path }}" class="margin-top-1 entity-action-form" data-action="unlock" data-entity-id="{{ entity.id }}">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="{{ unlock_action_value }}" />
                      <input type="hidden" name="entity_id" value="{{ entity.id }}" />
                      <input type="hidden" name="next" value="{{ request.get_full_path }}" />
                      <button class="button entity-unlock" type="submit">Unlock</button>
                    </form>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state" role="status">No entities found.</div>
    {% endif %}
  </div>
</div>
