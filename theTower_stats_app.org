* Stats Tracking App for The Tower Mobile Game 
** Goals/Intent
- Import data via raw text paste from The Tower either after a round or from 'Battle History'
  - Will check to dedupe imports 
  - Can delete saved runs 
- Stats are then tracked and charted over time via Analysis Engine
  - Computed Rates per Round over time
  - Deltas between Rounds
- Values are parsed from Raw Values stored in the DB and normalized/derived never destroyed
- Responsive Layout/UI
  - Battle Results form is designed for mobile
** Requirements
python
django
Chart.js
Foundation
Sass
sqlite
pytest
pytest-django
ruff
mypy
** Overall Architecture
Raw Game Data
   ↓ (parser)
Normalized Units
   ↓
Analysis Engine  ←──── Player Context
   ↓
Derived Metrics
   ↓
Charts / Views
** Features
- Import Data :: Page to drop in Round Results. 
- Charts :: Overview of Progress over time
- Card Library :: log and show card collection progress. Based on the work done here, https://docs.google.com/spreadsheets/d/1vmIA7SMLtjAY8OooS8JC8hod0Lgvr5WsXB5vIStBJJg/edit?usp=sharing
  - Card Preset Tagging
    Tag Cards into groupings and then filter display by groupings. Each card can be a part of multiple presets
  - Widget to show Card Slots unlocked with button to unlock next slot and label to show cost
    Maximum allowed for each preset
- Wiki Scraper :: Pull Data from the Fandom Wiki via Management Command
  Manual Buttons to check for update and fetch updates.
  Cite source
  Name property links to wiki page as well
  
  - Pull tables
  - Extract rows and columns
  - Normalize text (%, seconds, multipliers)


  Targets:
  - Bots Upgrades
  - Cards
  - Guardian Chips
  - UW Upgrade Table
** Core Responsibilities
*** Rate Calculations

- Derived per run and over time:
- Coins / hour
- Coins / wave
- Damage / wave
- Waves / real minute
- Resource gains per hour (cells, shards, etc.)

These back Phase 1 charts directly.

*** Delta Calculations

Between two runs or windows:
- Absolute delta
- Percentage delta
- Rolling averages

Examples:
- Coins/hour before vs after unlocking a slot
- Damage output change after a UW unlock

No interpretation — just math.

*** Parameterized Effects

Using wiki-derived tables:
- Effective cooldown at star level
- % reduction or multiplier applied
- EV calculations (e.g. wave skip)

These are:
- Deterministic
- Re-computable across revisions
- Fully testable with golden tests

*** Aggregations by Intent (Presets)

- Presets act as labels, not logic.
- Only One Preset can be active at a time
- The engine supports:
  - “Aggregate metrics for runs where preset X was active”
  - “Compare metrics across presets”

It does not decide which preset is better.

*** Analysis Engine Invocation

- Stateless
- Accepts:
  - Query params (date range, tier, context)
  - Returns DTOs only
  - No DB writes

*** Output Shape

All outputs should conform to a small set of DTO-style objects:

#+BEGIN_SRC python
DerivedMetric(
    key="coins_per_hour",
    value=Decimal,
    unit="coins/hour",
    run_id=UUID,
    context={...}
)

MetricSeries(
    key="coins_per_hour",
    points=[(timestamp, value), ...],
    context={tier, preset, uw, guardian}
)
#+END_SRC

This maps cleanly to Chart.js datasets.

*** Module Structure (Suggested)
analysis/
├── engine.py          # orchestration
├── rates.py           # per-hour, per-wave math
├── deltas.py          # comparisons
├── effects.py         # wiki-parameter-based calculations
├── aggregations.py    # preset / context grouping
├── dto.py             # output shapes
├── tests/
│   ├── test_rates.py
│   ├── test_effects.py
│   └── fixtures/

** UX Design

- Dark Mode Default
- Top Dynamic Nav
  - Docs / Admin links to the right
  - Global Search Box
- Maxed Out/Completed Upgrades are highlighted with a Gold Box outline
** Example Stat Data
Can be exported at the end of a round or retrieved from 'Battle History' 

#+BEGIN_SRC 
Battle Report
Battle Date	Dec 07, 2025 21:59
Game Time	10h 24m 52s
Real Time	2h 17m 23s
Tier	7
Wave	1301
Killed By	Boss
Coins earned	17.55M
Coins per hour	7.67M
Cash earned	$55.90M
Interest earned	$2.13M
Gem Blocks Tapped	3
Cells Earned	346
Reroll Shards Earned	373
Combat
Damage dealt	111.78q
Damage Taken	19.19B
Damage Taken Wall	3.39B
Damage Taken While Berserked	0
Damage Gain From Berserk	x0.00
Death Defy	1
Lifesteal	1.44M
Projectiles Damage	9.66q
Projectiles Count	450.74K
Thorn damage	433.07T
Orb Damage	11.35q
Enemies Hit by Orbs	2.84K
Land Mine Damage	3.40q
Land Mines Spawned	21340
Rend Armor Damage	0
Death Ray Damage	0
Smart Missile Damage	0
Inner Land Mine Damage	0
Chain Lightning Damage	81.18q
Death Wave Damage	8.72T
Tagged by Deathwave	6523
Swamp Damage	5.47q
Black Hole Damage	0
Electrons Damage	0
Utility
Waves Skipped	229
Recovery Packages	320
Free Attack Upgrade	687
Free Defense Upgrade	638
Free Utility Upgrade	653
HP From Death Wave	0.00
Coins From Death Wave	136.82K
Cash From Golden Tower	$18.91M
Coins From Golden Tower	2.18M
Coins From Black Hole	0
Coins From Spotlight	50.55K
Coins From Orb	0
Coins from Coin Upgrade	5.71M
Coins from Coin Bonuses	9.20M
Enemies Destroyed
Total Enemies	76623
Basic	46959
Fast	10196
Tank	10620
Ranged	7745
Boss	106
Protector	144
Total Elites	75
Vampires	24
Rays	24
Scatters	27
Saboteur	0
Commander	0
Overcharge	0
Destroyed By Orbs	2842
Destroyed by Thorns	18
Destroyed by Death Ray	0
Destroyed by Land Mine	8135
Destroyed in Spotlight	9112
Bots
Flame Bot Damage	264.78T
Thunder Bot Stuns	1.00K
Golden Bot Coins Earned	17.41K
Destroyed in Golden Bot	629
Guardian
Damage	18.75T
Summoned enemies	0
Guardian coins stolen	0
Coins Fetched	17.73K
Gems	1
Medals	1
Reroll Shards	12
Cannon Shards	0
Armor Shards	0
Generator Shards	3
Core Shards	0
Common Modules	0
Rare Modules	0
#+END_SR

** Models
*** Game Data
This is a large blob of data shown to the player at the end of each round of the game. They will paste it into this app as plain text. Consider this a snapshot at import time.

Properties:
- RawText :: string (raw input from user)
- ParsedAt :: datestring of when it was created
- checksum :: for deduping imports

### Subordinate Classes:  
**** RunProgress
  - tier :: integer
  - battle date :: datestring
  - real time :: duration
  - wave :: integer
  - killed by :: string
**** RunEarnings
  - Coins earned :: 
  - Coins per hour ::
  - Cash earned ::
  - Interest earned ::
  - Gem Blocks Tapped ::
  - Cells Earned ::
  - Reroll Shards Earned ::
**** RunCombat
  - Damage dealt	111.78q
  - Damage Taken	19.19B
  - Damage Taken Wall	3.39B
  - Damage Taken While Berserked	0
  - Damage Gain From Berserk	x0.00
  - Death Defy	1
  - Lifesteal	1.44M
  - Projectiles Damage	9.66q
  - Projectiles Count	450.74K
  - Thorn damage	433.07T
  - Orb Damage	11.35q
  - Enemies Hit by Orbs	2.84K
  - Land Mine Damage	3.40q
  - Land Mines Spawned	21340
  - Rend Armor Damage	0
  - Death Ray Damage	0
  - Smart Missile Damage	0
  - Inner Land Mine Damage	0
  - Chain Lightning Damage	81.18q
  - Death Wave Damage	8.72T
  - Tagged by Deathwave	6523
  - Swamp Damage	5.47q
  - Black Hole Damage	0
  - Electrons DamageDamage dealt	111.78q
  - Damage Taken	19.19B
  - Damage Taken Wall	3.39B
  - Damage Taken While Berserked	0
  - Damage Gain From Berserk	x0.00
  - Death Defy	1
  - Lifesteal	1.44M
  - Projectiles Damage	9.66q
  - Projectiles Count	450.74K
  - Thorn damage	433.07T
  - Orb Damage	11.35q
  - Enemies Hit by Orbs	2.84K
  - Land Mine Damage	3.40q
  - Land Mines Spawned	21340
  - Rend Armor Damage	0
  - Death Ray Damage	0
  - Smart Missile Damage	0
  - Inner Land Mine Damage	0
  - Chain Lightning Damage	81.18q
  - Death Wave Damage	8.72T
  - Tagged by Deathwave	6523
  - Swamp Damage	5.47q
  - Black Hole Damage	0
  - Electrons Damage
**** RunUtility
Waves Skipped	229
Recovery Packages	320
Free Attack Upgrade	687
Free Defense Upgrade	638
Free Utility Upgrade	653
HP From Death Wave	0.00
Coins From Death Wave	136.82K
Cash From Golden Tower	$18.91M
Coins From Golden Tower	2.18M
Coins From Black Hole	0
Coins From Spotlight	50.55K
Coins From Orb	0
Coins from Coin Upgrade	5.71M
Coins from Coin Bonuses	9.20M
**** RunEnemies
Total Enemies	76623
Basic	46959
Fast	10196
Tank	10620
Ranged	7745
Boss	106
Protector	144
Total Elites	75
Vampires	24
Rays	24
Scatters	27
Saboteur	0
Commander	0
Overcharge	0
Destroyed By Orbs	2842
Destroyed by Thorns	18
Destroyed by Death Ray	0
Destroyed by Land Mine	8135
Destroyed in Spotlight	9112
**** RunBots
Flame Bot Damage	264.78T
Thunder Bot Stuns	1.00K
Golden Bot Coins Earned	17.41K
Destroyed in Golden Bot	629
**** RunGuardian
Damage	18.75T
Summoned enemies	0
Guardian coins stolen	0
Coins Fetched	17.73K
Gems	1
Medals	1
Reroll Shards	12
Cannon Shards	0
Armor Shards	0
Generator Shards	3
Core Shards	0
Common Modules	0
Rare Modules	0
*** BotsParameters
Wiki-derived, FK to PlayerBots
Immutable per revision. When the wiki changes, insert a new row — don’t overwrite.

*** CardDefinition

Properties:
- Name  :: string
- rarity :: string
- base_effect
- max_effect
- preset_tags (FK)

*** CardLevel / Star
- card (FK)
- stars :: integer
- value :: value of current effect (between base and max)

*** CardParameters
Wiki-derived, FK to PlayerCard
Immutable per revision. When the wiki changes, insert a new row — don’t overwrite.

*** CardSlots
tracker for Card Slots unlocked, maximum of 21
Modified via Admin

Properties:
- Slot Number (label)
- Cost integer (Gems)

*** GuardianChipParemeters
Wiki-derived, FK to PlayerGuardianChip
Immutable per revision. When the wiki changes, insert a new row — don’t overwrite.

*** PlayerBot

Properties:
- bot :: FK to BotParameters
- unlocked :: checkbox

*** PlayerCard

Properties:
- card_definition (FK)
- unlocked :: checkbox
- Stars :: integer 1-7 
- Cards :: integer progress toward next level. 0, 3, 5, 8, 12, 20, 32
*** PlayerGuardianChip

Properties:
- chip :: FK to GuardianChipParameters
- unlocked :: checkbox
*** PlayerUltimateWeapon

Properties:
- UW :: FK to UtimateWeaponParameters
- unlocked :: checkbox
*** PresetTags
- Name :: string
- Cards (FK)
- limit :: FK with Card Slots
*** UltimateWeaponParameters
Wiki-derived, FK to PlayerUtimateWeapon
Immutable per revision. When the wiki changes, insert a new row — don’t overwrite.

- Object for each UW (Spotlight, Golden Tower, Death Wave, Smart Missle, Chrono Field, Poison Swamp, Inner Land Mine, Black Hole
- Tracks 3 properties for each, stone cost and stones invested
- Will need CLI script to import from CSV data

Properties:
- UW Name :: string
- Property Name :: string
- Cost :: integer (stones)
- Spent :: integer (stones)
*** Unit Model
Percent and 'x' multipliers use semantic wrapper (Multiplier(1.15))

Properties:
- raw_value :: string
- normalized_value :: decimal
- magnitude :: (k,10^3),  (m, 10^6), (b, 10^9), (t, 10^12), etc.
- unit_type :: coins, damage, count, time
*** WikiData
Stores the anchor names and retrived data caches for Card, Ultimate Weapons, and Guardian Chips. Entities not seen in the most recent scrape are marked deprecated but retained.

- Page URL
- Cannonical Name
- EntityID
- content_hash
- source_section (table / row / column)
- first_seen
- last_seen
- parse_version
** Views 
*** Battle History
View previously entered stats 
*** Cards
Combine 'Cards,' 'CardLevel' and 'CardSlots'
*** Charts
Charts are configured via URL params initially; saved views are out of scope.

Pretty dashboard of metrics over time (filterable by date range and tier)
- Default View is by Event (start is 12/9/2025 00:00 UTC)
- Filter by Tier or all

Top Level Charts:
- Coins Earned (line)
- Coins per Hour (line)

Sub Charts:
- Cash Earned
- Cells Earned
- Reroll Dice Earned 
**** UW Performance
Breakdown and Comparison Views of RunCombat filtered to Given UW
**** Guardian Stats
Breakdown and comparison views of RunGuardian over time
**** Comparison Charts
Phase 2 Charts (Contextual Overlays)

- Same metric, different tiers
- With / without specific preset active
- Moving averages
**** Derived Metrics
- Effective cooldown reduction
- Coins per wave vs wave number
*** UW Progress
- Button to add new UW
*** Guardian Progress
- Button to add new chip
- checkbox to flag equiped 
*** Bots Progress
- button to add new bot
** Management Commands
*** fetch_wiki_data

args:
- cards
- bots
- ultimate_weapons
- guardian_chips
- all (grabs all of the above)
- --check :: dry-run to find deltas

Explicit idempotency guarantee

Logging output format (even briefly)
Example:
- “Logs entity added / changed / unchanged counts”
  
*** add_battle_report
Ingest and parse battle report data from the player. This is a large blob of data shown to the player at the end of each round of the game. They will paste it into this app as plain text.

Parser should gracefully alert the player to new labels that may appear after a game update.
** Repo Structure
theTower_stats_app
├── analysis               # analysis/ contains no Django models or ORM access.
│   ├── engine.py          # orchestration
│   ├── rates.py           # per-hour, per-wave math
│   ├── deltas.py          # comparisons
│   ├── effects.py         # wiki-parameter-based calculations
│   ├── aggregations.py    # preset / context grouping
│   └── dto.py             # output shapes
├── archive                # misc project files excluded from the repo
├── core
│   └── __pycache__
├── docs
│   ├── 01_Introduction
│   ├── 02_Quickstart
│   ├── 03_Navigation
│   └── ...
├── theTower_stats_app
│   ├── __pycache__
│   ├── management
│   ├── migrations
│   ├── templates
│   ├── templatetags
│   ├── utils
│   └── views
├── scripts
├── static
├── tests
│   ├── __pycache__
│   ├── test_rates.py
│   ├── test_effects.py
│   └── fixtures/
└── ...

** Testing Standards
- Parser golden files (real pasted runs)
- Every parser or calculation gets at least one golden test
- Wiki scraper fixture snapshots
- Math correctness tests (especially EV)
- When completing code, start building/executing tests as specific as possible to the code you changed so that you can catch issues efficiently, then make your way to broader tests as you build confidence.
** Sprint Roadmap
Each phase must be demoable without admin intervention.
*** DONE Phase 1 Foundations
CLOSED: [2025-12-14 Sun 16:44]
- State "DONE"       from              [2025-12-14 Sun 16:44]
**** Milestones
- [X] AnalysisEngine scaffold
- [X] Rate calculations (coins/hour, waves/hour)
- [X] One time-series chart wired end-to-end
**** Exit Criteria [100%]
Goal: Prove the end-to-end pipeline works.

- [X] A pasted Battle Report:
  - Is parsed without crashing
  - Creates a GameData record and all subordinate Run* records
- [X] Duplicate imports are rejected via checksum
- [X] Unknown labels are surfaced to the user (non-fatal)

Analysis Engine
- [X] AnalysisEngine can be invoked with:
  - [X] a date range
  - [X] no player context
- [X] At least one rate calculation is implemented and tested:
  e.g. coins_per_hour

Charting
One Chart.js line chart:
- [X] Uses data only from MetricSeries
- [X] Updates when date range changes

Testing:
- At least:
  - [X] 1 parser golden test
  - [X] 1 rate calculation golden test
- [X] Test suite passes with no skipped tests
*** DONE Phase 2 Context
CLOSED: [2025-12-16 Tue 10:33]

- State "DONE"       from "IN PROGRESS" [2025-12-16 Tue 10:33]
- State "IN PROGRESS" from              [2025-12-16 Tue 09:22] \\
  Needs revisiting
**** Milestones
- [X] Tier filtering
- [X] Preset filtering
- [X] Delta calculations
**** Exit Criteria [100%]
Context Filters
- [X] Tier filter affects:
  - analysis output
  - chart display
- [X]  Preset filter:
  - allows selecting one active preset
  - correctly limits aggregation scope

Delta Calculations

- [X] At least one delta metric exists:
  - absolute and percentage

- [X] Delta calculations:
  - work between arbitrary time windows
  - are covered by golden tests

UX
- [X]  UI clearly shows when filters are active
- [X]  Clearing filters returns to baseline view

Testing
At least:
- [X] 1 delta golden test
- [X] 1 aggregation test using presets
*** DONE Phase 3 — App Structure & UX
CLOSED: [2025-12-16 Tue 09:22]

- State "DONE"       from              [2025-12-16 Tue 09:22]
**** Milestones [100%]
- [X] Navigation
- [X] Page separation
- [X] Dashboards
- [X] Model completeness (structure, not logic)
*** Phase 4 Effects

**** Scraping Sources and Corrective Behavior
- [X] Need a Management Command to Purge WikiData, Bot Definitions, Bot Levels, Bot Parameters, Guardian Chip Definitions, Guardian Chip levels, Guardian Chip Parameters, UW Definitions, UW Levels, UW Parameters.

  
- Each parameter can be upgraded individually, so they aren't in sync by level. Current level/level unlocked can be tracked within Parameters.
- Note parameters like Range, Duration and Cooldown are unique to each UW, Bot, or Chip

***** Bots
The scraper fetchs the wrong data/table. The 4 parameters for each bot share a cost value for the upgrades. Upgrades are purchased individually, so level isn't shared across them.

The cost is in Medals.

The labs tables are outside of the current scope.

- Thunder Bot :: Duration, Cooldown, Linger, Range. All that data is in the first table on https://the-tower-idle-tower-defense.fandom.com/wiki/Thunder_Bot
- Flame Bot :: Damage Reduction, Cooldown, Damage, Range. https://the-tower-idle-tower-defense.fandom.com/wiki/Flame_Bot
- Golden Bot :: Duration, Cooldown, Bonus, Range. https://the-tower-idle-tower-defense.fandom.com/wiki/Golden_Bot
- Amplify Bot :: Duration, Cooldown, Bonus, Range. https://the-tower-idle-tower-defense.fandom.com/wiki/Amplify_Bot

***** Ultimate Weapons

- 3 Parameters each, can be upgraded individually by level.
- Cost is in Stones
- Labs and Ultimate Weapon Plus are out outside of the current scope for tracking
- Similar to Bots, all levels are in the first table for each UW page, with an anchor for #Basic_Upgrades

- Chain Lightning :: Damage, Quantity, Chance https://the-tower-idle-tower-defense.fandom.com/wiki/Chain_Lightning

- Death Wave :: Damage Multiplier, Effect Wave, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Death_Wave#Basic_Upgrades

- Golden Tower :: Coins Multiplier, Duration, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Golden_Tower#Basic_Upgrades

- Spotlight :: Coins Bonus, Angle, Quantity (number of active spotlights) https://the-tower-idle-tower-defense.fandom.com/wiki/Spotlight#Basic_Upgrades

- Smart Missles :: Damage Multiplier, Quantity, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Smart_Missiles#Basic_Upgrades

- Chrono Field :: Duration, Slow, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Chrono_Field#Basic_Upgrades

- Inner Land Mines :: Damage %, Quantity, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Inner_Land_Mines#Basic_Upgrades

- Poison Swamp :: Damage Multiplier, Duration, Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Poison_Swamp#Basic_Upgrades

- Black Hole :: Size, Duration Cooldown https://the-tower-idle-tower-defense.fandom.com/wiki/Black_Hole#Basic_Upgrades

***** Guardian Chips
- There are currently 5 chips available
- Costs are in Bits
- 3 Parameters Each
- All information is located on https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian with a unique anchor for each chip

  
- Ally :: Recovery Amount, Cooldown, Max Recovery https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian#Ally
- Attack :: Percentage, Cooldown, Targets
  These are tracked in Battle Reports https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian#Attack
- Fetch :: Cooldown, Find Chance %, Double Find Chance
  These are tracked in Battle Reports. Note there is an irrelevant table above Upgrades for this chip  https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian#Fetch
- Bounty :: Multiplier, Cooldown, Targets
  https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian#Bounty
- Summon :: Cooldown, Duration, Cash Bonus
  https://the-tower-idle-tower-defense.fandom.com/wiki/Guardian#Summon

***** Cards
- All listed on https://the-tower-idle-tower-defense.fandom.com/wiki/Cards#List_of_Cards
- 'Description' Column explains target and how it's modified
- Card Slots are unlocked with Gems.

**** Milestones
- [X] CardParameters → effective values
- [X] UW / Guardian parameterized metrics
- [ ] Derived metrics charts
**** Exit Criteria [50%]
Wiki Effects Infrastructure
- [X] At least one complete pipeline:
  - scrape → version → reference → compute
- [X] Demonstrated on one entity type (pick one):
  - UW or Bot or Guardian
- [X] Wiki revision change produces different derived output
- [X] Golden test proving revision safety
- [ ] One derived effect chart rendered dynamically

Parameterized Effects
- [ ]  At least one wiki-derived parameter table is:
  - scraped
  - versioned
  - referenced by the Analysis Engine

- [ ] At least one effect calculation exists:
  - e.g. effective cooldown or EV of wave skip

Derived Metrics
- [ ] Derived metrics:
  - are computed dynamically
  - are not persisted
- [ ] Derived metrics appear as charts:
  - alongside raw metrics
  - with correct units

Backward Safety
- [X]  Changing wiki parameters:
  - does not invalidate existing runs
  - produces different derived results when re-run

Testing
 - At least:
   - [X] 1 golden test for a parameterized effect
   - [X] 1 test validating revision behavior
*** Phase 5 Dashboard UX [0%]
Goal:
- Turn the analysis engine outputs into clear, usable, player-facing dashboards.
- No new math. No new scraping logic. No new domain models.

Previous drafts indicated using Tailwind CSS for this project. We will now be implementing Foundation Framework.

General conventions across all Dashboards:
- Nav Header
- Global Search Box
- Links to Docs and Admin
- Apply Foundation styles consistently
- Establish shared dashboard components:
  - Filters (Tier, Date Range, Preset)
  - Empty states
  - Loading states
**** TODO Battle History
- Display Results in a Styled Table with Sortable Columns
- Include:
  - Killed By	Boss
  - Coins earned	1.24M
  - Coins per hour	4.24M
  - Cash earned	$1.00M
  - Interest earned	$220.24K
  - Gem Blocks Tapped	1
  - Cells Earned	0
  - Reroll Shards Earned	94
- Filter by Tier, Killed By
- Can be paginated 
**** TODO Charts
Pretty dashboard of metrics over time (filterable by date range and tier)

Support:
- Date range filter. Default View is by Event (start is 12/9/2025 00:00 UTC)
- Tier filter
- Ensure all charts consume MetricSeries only

Top Level Charts:
- Coins Earned (line)
- Coins per Hour (line)

Sub Charts:
- Cash Earned
- Cells Earned
- Reroll Dice Earned

- UW Performance
  : Breakdown and Comparison Views of RunCombat filtered to Given UW
  : - List unlocked UWs
  : - Show parameter levels + effective values
- Guardian Stats
  : Breakdown and comparison views of RunGuardian over time
  : Equipped State
  : Parameter Summary
- Bots Stats 
- Comparison Charts
  - Same metric, different tiers
  - With / without specific preset active
  - Moving averages
- Derived Metrics
  - Effective cooldown reduction
  - Coins per wave vs wave number
**** TODO Cards
- Show a utility widget with 'CardSlots' Unlocked and a button to 'Unlock Next Slot'
- List all Cards in a Collapsible Table
  - Multiselect to add/create preset
  - textbox to enter current inventory
  - Display 'CardLevel' and 'CardParameters'
  - Filter by Preset
**** TODO UW Progress
**** TODO Guardian Chip Progress
The naming is important 
**** TODO Bots Progress
**** TODO Add Github Action to publish Docs to Github Pages
**** TODO [#C] Documentation and Polish 
- Add Material Theme, mkdocstrings-python support
  Similar to mscrInventory's mkdocs.yml

  #+BEGIN_SRC yml
  
theme:
  name: material
  language: en
  palette:
    - scheme: default
      primary: indigo
      accent: blue
  features:
    - navigation.instant
    - navigation.sections
    - navigation.expand
    - navigation.path
    - navigation.top
    - search.suggest
    - search.highlight
    - search.share
    - toc.integrate
    - content.tabs.link
    - content.code.copy
  icon:
    repo: fontawesome/brands/github

markdown_extensions:
  - admonition
  - toc:
      permalink: true
  - footnotes
  - tables
  - fenced_code
  - codehilite:
      guess_lang: false
  - def_list
  - attr_list
  - md_in_html
  - admonition
  - pymdownx.details
  - pymdownx.extra
  - pymdownx.superfences
  - pymdownx.highlight
  - pymdownx.inlinehilite
  - pymdownx.snippets
  - pymdownx.magiclink
  - pymdownx.mark
  - pymdownx.keys
  - pymdownx.tasklist:
      custom_checkbox: true
  - pymdownx.emoji:
      emoji_generator: !!python/name:pymdownx.emoji.to_svg

  plugins:
  - search
  - mkdocstrings:
      handlers:
        python:
          paths: ["."]
          options:
            show_source: true
            docstring_style: google
            merge_init_into_class: true
  - autorefs
  #+END_SRC
- Move Phase 1, Phase 2, Phase 2.75, Phase 3, and Phase 4 under 'Development'
- Merge 'Management Command' section for 'fetch_wiki_data' with 'Wiki Population' page
- Add Docs for Each Dashboard
  - Callout Charts and Cards in index.md
**** TODO Need method for handling Player Bots/Cards/UW/Gaurdian Chips
Hasn't been built out or thought out yet.
**** Milestones
- [ ] All dashboards share a single visual and structural language
- [ ] On Battle History Player can scan, filter, and trust historical data quickly
- [ ] A new contributor understands the app without a walkthrough
**** Exit Criteria [0%]
UX & Data Integrity:
- [ ] Dashboards display only computed outputs
- [ ] No dashboard performs calculations inline
- [ ] All filters affect views consistently

Coverage:
Every major entity has a visible dashboard:
- [ ] Battle History
- [ ] Charts
- [ ] Cards
- [ ] UWs
- [ ] Guardians
- [ ] Bots

Stability:
- [ ] No new models added
- [ ] No migrations required
- [ ] Test suite passes unchanged

### Demo Test
A new user can:
1. Import runs
2. View history
3. Inspect progress
4. Understand trends …without explanation.
** Backlog [1/5]
“Out of Scope”:
- Cloud sync
- Real-time scraping
  
*** TODO [#B] Comparison / Scenario View

Examples:
- Run A vs Run B
- Before vs after unlocking card slot
- With Guardian Chip/UW X vs without

This is where the app becomes decision-making, not logging.
*** TODO [#B] Add Advice for Optimization
Based on logged performance data, it could be possible to calculate and offer suggestions based on the data.

For Example:
- Which UW to unlock next
- Bot properties to improve
- Guardian Chip properties to improve
- Weighted Preset Rankings
*** TODO [#C] Linking Presets/UW/Guardian Chips/Bots to battle history
Mostly a visual tweak, but adds context and history for the player to interpert their performance history. 
*** TODO [#A] Allow Multiple Players to Store
**** Core Principle: Everything Belongs to a Player

Yes: every player-specific model must be bound to a Player.

Recommended structure:

#+BEGIN_SRC python
from django.contrib.auth.models import User

class Player(models.Model):
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    display_name = models.CharField(max_length=64)
    created_at = models.DateTimeField(auto_now_add=True)
#+END_SRC

Then every mutable/progress model gets:
#+BEGIN_SRC python
player = models.ForeignKey(Player, on_delete=models.CASCADE)
#+END_SRC

This includes:
- player_cards
- player_relics
- player_labs
- battle_report
- run_history
- sim_results
- etc.

**** Authorization

Use groups + permissions, not custom flags.

Suggested groups
|Group |Purpose |
|---+---|
|admin | me |
|player| Default |

You can enforce almost everything via queryset filtering, not permissions alone.

**** Queryset Filtering Is the Real Security Layer

Permissions stop access.
Querysets prevent data leaks.

Pattern you’ll use everywhere

#+BEGIN_SRC python
def get_queryset(self):
    user = self.request.user
    if user.is_superuser:
        return Model.objects.all()
    return Model.objects.filter(player__user=user)
#+END_SRC

This applies to:
- Admin
- API views
- List views
- Export endpoints
- Sim endpoints

If you forget this once, players see each other’s data.

**** Django Admin: Lock It Down Properly
ModelAdmin example
#+BEGIN_SRC python
class PlayerCardAdmin(admin.ModelAdmin):
    def get_queryset(self, request):
        qs = super().get_queryset(request)
        if request.user.is_superuser:
            return qs
        return qs.filter(player__user=request.user)

    def save_model(self, request, obj, form, change):
        if not change:
            obj.player = request.user.player
        super().save_model(request, obj, form, change)
#+END_SRC

Also:

Remove player from editable fields for non-admins

Use readonly_fields where possible

**** API Layer (Even If You Don’t Build One Yet)

Design as if you will.

Never accept player_id from the client

Always derive it from request.user.

❌ Bad

{ "player_id": 12, "wave": 4500 }


✅ Good

player = request.user.player


This avoids spoofing and simplifies logic everywhere.

**** Shared vs Player-Scoped Models (Important Distinction)

You’ll have three categories of models:

A. Global Reference Data (NO player FK)

Cards

Relics

Labs

Enemies

Waves

Balance constants

These are read-only.

B. Player State (HAS player FK)

PlayerCard

PlayerRelic

PlayerLabProgress

Unlocks

Inventory

C. Derived / Cached Results (HAS player FK)

BattleReport

SimulationRun

AggregatedStats

You can safely delete category C anytime.

**** Data Migration & Onboarding Flow

You’ll need a clean onboarding path:

User creates account

Auto-create Player via signal

Assign default group player

Initialize baseline progress rows

@receiver(post_save, sender=User)
def create_player(sender, instance, created, **kwargs):
    if created:
        Player.objects.create(user=instance)

*** DONE [#A] Fix pytest warnings
CLOSED: [2025-12-16 Tue 11:01]
- State "DONE"       from "TODO"       [2025-12-16 Tue 11:01]
definitions/models.py:279
  /Users/mrmax/projects/theTowerStats/definitions/models.py:279: RemovedInDjango60Warning: CheckConstraint.check is deprecated in favor of `.condition`.
    models.CheckConstraint(

definitions/models.py:343
  /Users/mrmax/projects/theTowerStats/definitions/models.py:343: RemovedInDjango60Warning: CheckConstraint.check is deprecated in favor of `.condition`.
    models.CheckConstraint(

definitions/models.py:407
  /Users/mrmax/projects/theTowerStats/definitions/models.py:407: RemovedInDjango60Warning: CheckConstraint.check is deprecated in favor of `.condition`.
    models.CheckConstraint(

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
